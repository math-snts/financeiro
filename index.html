<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meu Controle Financeiro</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <style>
    /* Seus estilos originais aqui */
  </style>
</head>
<body>
  <!-- Conte√∫do HTML mantido -->
  <script>
  // ======= FUN√á√ïES GERAIS =======
  const fmtBRL = (n) => (n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const parseN = (v) => Number(String(v).replace(',','.'))||0;
  const today = () => new Date();
  const getPeriod = (d) => {
    const date=new Date(d||today());
    return date.getFullYear()+"-"+String(date.getMonth()+1).padStart(2,'0');
  };

  let state = JSON.parse(localStorage.getItem('fin-state')||'{}');
  if(!state.periodos) state={periodos:{},tipos:["Moradia","Transporte","Alimenta√ß√£o","Sa√∫de","Servi√ßos","Educa√ß√£o","Outros"]};
  let currentPeriod;

  function ensurePeriod(p){
    if(!state.periodos[p]) state.periodos[p]={rendas:[],despesas:[],cartoes:[]};
  }
  function save(){ localStorage.setItem('fin-state',JSON.stringify(state)); renderAll(); }

  // ======= PERIODOS =======
  function renderPeriods(){
    const sel=document.getElementById('periodSelect'); sel.innerHTML="";
    const ps=Object.keys(state.periodos).sort();
    ps.forEach(p=>{
      const opt=document.createElement('option');
      opt.value=p; opt.textContent=p; sel.appendChild(opt);
    });
    if(!currentPeriod){currentPeriod=getPeriod(); ensurePeriod(currentPeriod);}
    if(!ps.includes(currentPeriod)){ensurePeriod(currentPeriod);}
    sel.value=currentPeriod;
    sel.onchange=()=>{currentPeriod=sel.value; renderAll();};
  }

  // ======= RENDAS =======
  document.getElementById('btnAddRenda').onclick=()=>{
    const nome=document.getElementById('rendaNome').value.trim();
    const valor=parseN(document.getElementById('rendaValor').value);
    const data=document.getElementById('rendaData').value;
    const meses=parseInt(document.getElementById('rendaRecorrente').value);
    if(!nome||!valor||!data){alert("Preencha os campos");return;}

    const p=getPeriod(data);
    ensurePeriod(p);
    state.periodos[p].rendas.push({id:Date.now(),nome,valor,data,recorrente:meses>0});
    currentPeriod=p;

    if(meses>0){
      for(let i=1;i<meses;i++){
        let d=new Date(data); d.setMonth(d.getMonth()+i);
        const pi=getPeriod(d);
        ensurePeriod(pi);
        state.periodos[pi].rendas.push({id:Date.now()+i,nome,valor,data:d.toISOString(),recorrente:true});
      }
    }

    document.getElementById('rendaNome').value="";
    document.getElementById('rendaValor').value="";
    document.getElementById('rendaData').value="";
    document.getElementById('rendaRecorrente').value="0";
    save();
  };
  function renderRenda(){
    ensurePeriod(currentPeriod);
    const tb=document.querySelector('#tblRenda tbody'); tb.innerHTML="";
    state.periodos[currentPeriod].rendas.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.nome}</td><td>${new Date(r.data).toLocaleDateString()}</td><td class="right">${fmtBRL(r.valor)}</td><td><button class="btn ghost">X</button></td>`;
      tr.querySelector('button').onclick=()=>{state.periodos[currentPeriod].rendas=state.periodos[currentPeriod].rendas.filter(x=>x.id!==r.id); save();};
      tb.appendChild(tr);
    });
  }

  // ======= TIPOS DESPESAS =======
  function renderTipos(){
    const sel=document.getElementById('despTipo'); sel.innerHTML="";
    state.tipos.forEach(t=>{const o=document.createElement('option'); o.textContent=t; sel.appendChild(o);});
  }
  document.getElementById('btnAddTipo').onclick=()=>{
    const v=document.getElementById('novoTipo').value.trim();
    if(v){state.tipos.push(v); document.getElementById('novoTipo').value=""; save();}
  };

  // ======= DESPESAS =======
  document.getElementById('btnAddDesp').onclick=()=>{
    const nome=document.getElementById('despNome').value.trim();
    const valor=parseN(document.getElementById('despValor').value);
    const data=document.getElementById('despData').value;
    const tipo=document.getElementById('despTipo').value;
    const meses=parseInt(document.getElementById('despRecorrente').value);
    if(!nome||!valor||!data){alert("Preencha os campos");return;}

    const p=getPeriod(data);
    ensurePeriod(p);
    state.periodos[p].despesas.push({id:Date.now(),nome,valor,data,tipo,recorrente:meses>0});
    currentPeriod=p;

    if(meses>0){
      for(let i=1;i<meses;i++){
        let d=new Date(data); d.setMonth(d.getMonth()+i);
        const pi=getPeriod(d);
        ensurePeriod(pi);
        state.periodos[pi].despesas.push({id:Date.now()+i,nome,valor,data:d.toISOString(),tipo,recorrente:true});
      }
    }

    document.getElementById('despNome').value="";
    document.getElementById('despValor').value="";
    document.getElementById('despData').value="";
    document.getElementById('despRecorrente').value="0";
    save();
  };
  function renderDesp(){
    ensurePeriod(currentPeriod);
    const tb=document.querySelector('#tblDesp tbody'); tb.innerHTML="";
    state.periodos[currentPeriod].despesas.forEach(d=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${d.nome}</td><td>${new Date(d.data).toLocaleDateString()}</td><td>${d.tipo}</td><td class="right">${fmtBRL(d.valor)}</td><td><button class="btn ghost">X</button></td>`;
      tr.querySelector('button').onclick=()=>{state.periodos[currentPeriod].despesas=state.periodos[currentPeriod].despesas.filter(x=>x.id!==d.id); save();};
      tb.appendChild(tr);
    });
  }

  // ======= CART√ïES =======
  document.getElementById('btnAddCC').onclick=()=>{
    const nome=document.getElementById('ccNome').value.trim();
    const valor=parseN(document.getElementById('ccValor').value);
    const venc=document.getElementById('ccVenc').value;
    if(!nome||!valor||!venc){alert("Preencha os campos");return;}
    const p=getPeriod(venc);
    ensurePeriod(p);
    state.periodos[p].cartoes.push({id:Date.now(),nome,valor,venc});
    currentPeriod=p;
    document.getElementById('ccNome').value="";
    document.getElementById('ccValor').value="";
    document.getElementById('ccVenc').value="";
    save();
  };
  function renderCC(){
    ensurePeriod(currentPeriod);
    const tb=document.querySelector('#tblCC tbody'); tb.innerHTML="";
    state.periodos[currentPeriod].cartoes.forEach(c=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${c.nome}</td><td>${new Date(c.venc).toLocaleDateString()}</td><td class="right">${fmtBRL(c.valor)}</td><td><button class="btn ghost">X</button></td>`;
      tr.querySelector('button').onclick=()=>{state.periodos[currentPeriod].cartoes=state.periodos[currentPeriod].cartoes.filter(x=>x.id!==c.id); save();};
      tb.appendChild(tr);
    });
  }

  // ======= DASHBOARD =======
  function renderDashboard(){
    ensurePeriod(currentPeriod);
    const rendas=state.periodos[currentPeriod].rendas||[];
    const despesas=state.periodos[currentPeriod].despesas||[];
    const cartoes=state.periodos[currentPeriod].cartoes||[];
    const totalR=rendas.reduce((s,x)=>s+x.valor,0);
    const totalD=despesas.reduce((s,x)=>s+x.valor,0);
    const totalC=cartoes.reduce((s,x)=>s+x.valor,0);
    const saldo=totalR;
    document.getElementById('kpiSaldo').textContent=fmtBRL(saldo);
    document.getElementById('kpiSobra').textContent=fmtBRL(saldo-totalD-totalC);

    const eventos=[...despesas.map(d=>({data:d.data,nome:d.nome})),...cartoes.map(c=>({data:c.venc,nome:c.nome}))];
    const futuros=eventos.filter(e=>new Date(e.data)>=today());
    futuros.sort((a,b)=>new Date(a.data)-new Date(b.data));
    document.getElementById('kpiVencimento').textContent=futuros.length? new Date(futuros[0].data).toLocaleDateString()+" - "+futuros[0].nome:"‚Äî";
  }

  // ======= Config Dados =======
  document.getElementById('btnReset').onclick=()=>{ if(confirm("Apagar todos os dados?")){localStorage.removeItem('fin-state'); location.reload();} };

  // ======= TABS =======
  const tabNames=[["dashboard","Dashboard"],["renda","Renda"],["despesas","Despesas"],["cartoes","Cart√µes"],["relatorios","Config Dados"]];
  function renderTabs(){
    const nav=document.getElementById('tabs'); nav.innerHTML="";
    tabNames.forEach(([id,label],i)=>{
      const b=document.createElement('button'); b.textContent=label; if(i==0) b.classList.add('active');
      b.onclick=()=>{document.querySelectorAll('.tab').forEach(t=>t.hidden=true); document.getElementById('tab-'+id).hidden=false; document.querySelectorAll('nav button').forEach(x=>x.classList.remove('active')); b.classList.add('active');};
      nav.appendChild(b);
    });
    document.getElementById('tab-dashboard').hidden=false;
  }

  // ======= TEMA =======
  const themeToggle=document.getElementById('themeToggle');
  const themeIcon=document.getElementById('themeIcon');
  function applyTheme(){
    if(localStorage.getItem('theme')==='light'){
      document.body.classList.add('light');
      themeToggle.checked=false;
      themeIcon.textContent='üåû';
    } else {
      document.body.classList.remove('light');
      themeToggle.checked=true;
      themeIcon.textContent='üåô';
    }
  }
  themeToggle.onchange=()=>{localStorage.setItem('theme', themeToggle.checked?'dark':'light'); applyTheme();};

  // ======= L√ìGICA FREE VS PREMIUM =======
  (function(){
    const plano = "premium"; 
    const select = (sel) => document.querySelector(sel);
    const remove = (sel) => { const el=select(sel); if(el) el.remove(); };

    if(plano === "free"){
      remove("#cardSomaTipos");
      remove("#periodSelect");
      remove("#novoTipo");
      remove("#btnAddTipo");
      remove("#boxRendaRec");
      remove("#boxDespRec");

      const tabBtn = Array.from(document.querySelectorAll("nav button"))
        .find(btn => btn.textContent.includes("Cart√µes"));
      if(tabBtn) tabBtn.remove();
      remove("#tab-cartoes");
    }
  })();

  // ======= RENDER ALL =======
  function renderAll(){
    renderPeriods();
    renderRenda();
    renderTipos();
    renderDesp();
    renderCC();
    renderDashboard();
  }

  renderTabs();
  applyTheme();
  renderAll();
  </script>
  <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
      .then(() => console.log("Service Worker registrado"));
  }
  </script>
</body>
</html>
