<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meu Controle Financeiro</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <style>
    :root {
      --bg: #3f3f3f;
      --card: #444444;
      --muted: #1f2937;
      --text: #e5e7eb;
      --text-dim: #9ca3af;
      --accent: #22c55e;
      --accent-2: #3b82f6;
      --danger: #ef4444;
      --warn: #f59e0b;
      --radius: 18px;
    }
    body.light {
      --bg: #f9fafb;
      --card: #ffffff;
      --muted: #e5e7eb;
      --text: #111827;
      --text-dim: #374151;
      --accent: #22c55e;
      --accent-2: #2563eb;
      --danger: #dc2626;
      --warn: #d97706;
    }
    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
    }
    header {
      position: sticky;
      top: 0;
      background: rgba(58, 58, 58, 0.8);
      backdrop-filter: saturate(180%) blur(8px);
      border-bottom: 1px solid var(--muted);
      z-index: 10;
    }
    body.light header { background: rgba(249,250,251,.8); }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 18px }
    .row { display: flex; gap: 12px; flex-wrap: wrap }
    .grow { flex: 1 1 280px }
    h1 { font-size: 22px; margin: 0; font-weight: 700 }
    nav { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px }
    nav button {
      background: var(--bg);
      border: 1px solid var(--muted);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 999px;
      cursor: pointer;
    }
    nav button.active {
      background: var(--accent-2);
      border-color: transparent;
      color: #fff;
    }
    main { max-width: 1100px; margin: 16px auto; padding: 0 18px 70px }
    .grid { display: grid; gap: 14px }
    .grid.cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)) }
    @media (max-width:900px){.grid.cols-3{grid-template-columns:1fr}}
    .card {
      background: var(--card);
      border: 1px solid var(--muted);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: 0 6px 30px rgba(0,0,0,.25);
    }
    .card h2 { margin: 0 0 12px; font-size: 18px }
    .muted { color: var(--text-dim) }
    .kpi { font-size: 26px; font-weight: 800 }
    .row-inline { display: flex; align-items: center; gap: 6px; flex-wrap: wrap }
    label { font-size: 12px; color: var(--text-dim) }
    input,select,textarea {
      width: 100%; padding: 10px 12px; background: var(--bg);
      border: 1px solid var(--muted); border-radius: 12px; color: var(--text)
    }
    textarea { resize: vertical; min-height: 100px }
    .btn {
      background: var(--accent-2);
      color: white; border: none;
      padding: 10px 14px; border-radius: 12px;
      cursor: pointer; font-weight: 600
    }
    .btn.ghost { background: var(--bg); border: 1px solid var(--muted); color: var(--text) }
    .btn.warn { background: var(--warn) }
    .btn.danger { background: var(--danger) }
    table { width: 100%; border-collapse: collapse }
    th, td { padding: 10px; border-bottom: 1px solid var(--muted); text-align: left }
    th { color: var(--text-dim); font-weight: 600; font-size: 12px; text-transform: uppercase }
    tfoot td { font-weight: 700 }
    .tag { padding: 4px 8px; border-radius: 999px; font-size: 11px; border: 1px solid var(--muted) }
    .right { text-align: right }
    .space-top { margin-top: 12px }
    .note { font-size: 12px; color: var(--text-dim) }
    footer { position: fixed; bottom: 10px; left: 0; right: 0; display: flex; justify-content: center; pointer-events: none }
    .dock { pointer-events: auto; background: var(--bg); border: 1px solid var(--muted); border-radius: 999px; padding: 8px 10px; display: flex; gap: 8px; box-shadow: 0 10px 30px rgba(0,0,0,.35) }
    .switch { position: relative; display: inline-flex; align-items: center; gap:6px; cursor: pointer; }
    .switch input { display:none }
    .slider {
      width: 46px; height: 24px; background: var(--muted); border-radius: 999px;
      position: relative; transition:.3s;
    }
    .slider::before {
      content:""; position:absolute; top:2px; left:2px;
      width:20px; height:20px; border-radius:50%;
      background:#fff; transition:.3s;
    }
    input:checked + .slider::before { transform: translateX(22px) }
    input:checked + .slider { background: var(--accent-2) }
    .table-container { overflow-x: auto; }
    #tblDesp { width: 100%; border-collapse: collapse; }
    #tblDesp th, #tblDesp td { padding: 6px 8px; text-align: left; white-space: nowrap; }
    #tblDesp th.right, #tblDesp td.right { text-align: right; }
    @media (max-width: 600px) {
      #tblDesp th:nth-child(2), #tblDesp td:nth-child(2),
      #tblDesp th:nth-child(3), #tblDesp td:nth-child(3) { display: none; }
    }

    /* === Metas === */
    .goals-grid { display: grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 14px }
    @media (max-width:900px){.goals-grid{grid-template-columns:1fr}}
    .goal-card { position: relative; }
    .goal-close { position:absolute; top:8px; right:8px; background: transparent; border:none; color: var(--text-dim); cursor:pointer; font-weight:700 }
    .progress { height: 12px; background: var(--muted); border-radius: 999px; overflow:hidden; }
    .progress > span { display:block; height:100%; width:0%; transition: width .3s ease; }
    .p-red { background:#ef4444 }
    .p-orange { background:#f59e0b }
    .p-green { background:#22c55e }
    .p-gold { background:linear-gradient(90deg,#f59e0b,#fbbf24,#f59e0b) }
    .goal-nums { display:flex; justify-content:space-between; font-size:12px; color:var(--text-dim) }

    /* === Listas (post-it) === */
    .notes-header { display:flex; justify-content:space-between; align-items:center; gap:8px }
    .notes-grid { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:14px; margin-top:12px }
    @media(max-width:1100px){.notes-grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:600px){.notes-grid{grid-template-columns:1fr}}
    .note-item { position:relative; background:#fef08a; color:#111; border-radius: 10px; padding:14px; box-shadow: 0 10px 25px rgba(0,0,0,.25); min-height: 160px; }
    body.light .note-item { color:#111 }
    .note-delete { position:absolute; top:6px; right:8px; background: transparent; border:none; font-weight:700; cursor:pointer }
    .note-text { width:100%; background: transparent; border:none; outline:none; color: inherit; font: inherit; min-height: 100px; resize: none }
    .note-footer { position:absolute; left:8px; bottom:8px; display:flex; align-items:center; gap:6px }
    .note-done { width:18px; height:18px }
    .note-item.done { opacity:.7; text-decoration: line-through; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row" style="align-items:center;justify-content:space-between">
        <div class="grow">
          <h1>💰 Meu Controle Financeiro</h1>
          <div class="muted">Controle seus ganhos e despesas por período</div>
        </div>
        <div class="row-inline">
          <select id="periodSelect" class="btn ghost" style="width:auto"></select>
          <label class="switch">
            <span id="themeIcon">🌞</span>
            <input type="checkbox" id="themeToggle">
            <span class="slider"></span>
          </label>
        </div>
      </div>
      <nav id="tabs"></nav>
    </div>
  </header>
  <main>
    <!-- DASHBOARD -->
    <section id="tab-dashboard" class="tab card" hidden>
      <h2>📊 Dashboard</h2>
      <div class="grid cols-3">
        <div class="card">
          <div class="muted">Saldo previsto</div>
          <div class="kpi" id="kpiSaldo">R$ 0,00</div>
          <div class="note">Entradas</div>
        </div>
        <div class="card">
          <div class="muted">Total de Despesas</div>
          <div class="kpi" id="kpisomadiv">—</div>
          <div class="note">Soma de todas as despesas + cartões</div>
        </div>
        <div class="card">
          <div class="muted">Sobra</div>
          <div class="kpi" id="kpiSobra">R$ 0,00</div>
          <div class="note">Saldo após todas as despesas</div>
        </div>
        <div class="card">
          <div class="kpi" id="kpiVencimento">—</div>
          <div class="note">Despesas e cartões a vencer</div>
        </div>
      </div>
    </section>

    <!-- RENDA -->
    <section id="tab-renda" class="tab card" hidden>
      <h2>💵 Renda</h2>
      <div class="row">
        <div class="grow"><label>Descrição</label><input id="rendaNome" placeholder="Salário, Extra..."></div>
        <div class="grow"><label>Valor</label><input id="rendaValor" type="number" step="0.01"></div>
        <div class="grow"><label>Data</label><input id="rendaData" type="date"></div>
        <div class="row-inline" id="boxRendaRec">
          <label for="rendaRecorrente">Recorrente</label>
          <select id="rendaRecorrente">
            <option value="0">Não</option>
            <option value="1">1 mês</option>
            <option value="2">2 meses</option>
            <option value="3">3 meses</option>
            <option value="4">4 meses</option>
            <option value="5">5 meses</option>
            <option value="6">6 meses</option>
            <option value="7">7 meses</option>
            <option value="8">8 meses</option>
            <option value="9">9 meses</option>
            <option value="10">10 meses</option>
            <option value="11">11 meses</option>
            <option value="12">12 meses</option>
          </select>
        </div>
        <button id="btnAddRenda" class="btn">Adicionar</button>
      </div>
      <div class="space-top">
        <table id="tblRenda">
          <thead>
            <tr><th>Descrição</th><th>Data</th><th class="right">Valor</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- DESPESAS -->
    <section id="tab-despesas" class="tab card" hidden>
      <h2>📌 Despesas</h2>
      <div class="row">
        <div class="grow"><label>Descrição</label><input id="despNome"></div>
        <div class="grow"><label>Valor</label><input id="despValor" type="number" step="0.01"></div>
        <div class="grow"><label>Data vencimento</label><input id="despData" type="date"></div>
        <div class="grow"><label>Tipo</label>
          <select id="despTipo"></select>
        </div>
        <div class="row-inline">
          <input id="novoTipo" placeholder="Novo tipo" style="width:120px">
          <button id="btnAddTipo" class="btn ghost">+</button>
        </div>
        <div class="row-inline" id="boxDespRec">
          <label for="despRecorrente">Recorrente</label>
          <select id="despRecorrente">
            <option value="0">Não</option>
            <option value="1">1 mês</option>
            <option value="2">2 meses</option>
            <option value="3">3 meses</option>
            <option value="4">4 meses</option>
            <option value="5">5 meses</option>
            <option value="6">6 meses</option>
            <option value="7">7 meses</option>
            <option value="8">8 meses</option>
            <option value="9">9 meses</option>
            <option value="10">10 meses</option>
            <option value="11">11 meses</option>
            <option value="12">12 meses</option>
          </select>
        </div>
        <button id="btnAddDesp" class="btn">Adicionar</button>
      </div>
      <div class="space-top table-container">
        <table id="tblDesp">
          <thead>
            <tr>
              <th>Descrição</th>
              <th>Data</th>
              <th>Tipo</th>
              <th class="right">Valor</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- CARTÕES -->
    <section id="tab-cartoes" class="tab card" hidden>
      <h2>💳 Cartões</h2>
      <div class="row">
        <div class="grow"><label>Cartão</label><input id="ccNome"></div>
        <div class="grow"><label>Vencimento</label><input id="ccVenc" type="date"></div>
        <div class="grow"><label>Valor usado</label><input id="ccValor" type="number" step="0.01"></div>
        <button id="btnAddCC" class="btn">Adicionar</button>
      </div>
      <div class="space-top">
        <table id="tblCC">
          <thead>
            <tr><th>Cartão</th><th>Vencimento</th><th class="right">Valor usado</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- METAS -->
    <section id="tab-metas" class="tab card" hidden>
      <h2>🎯 Metas</h2>
      <div class="row">
        <div class="grow"><label>Descrição</label><input id="metaDesc" placeholder="Ex.: Notebook, Viagem..."></div>
        <div class="grow"><label>Valor da meta</label><input id="metaValor" type="number" step="0.01" placeholder="0,00"></div>
        <button id="btnAddMeta" class="btn">Adicionar meta</button>
      </div>
      <div class="space-top goals-grid" id="goalsGrid"></div>
    </section>

    <!-- LISTAS -->
    <section id="tab-listas" class="tab card" hidden>
      <div class="notes-header">
        <h2>🗒️ Post-it</h2>
        <button id="btnNovaNota" class="btn" style="margin-left:auto">➕ Nova nota</button>
      </div>
      <div class="notes-grid" id="notesGrid"></div>
    </section>

    <!-- CONFIG -->
    <section id="tab-relatorios" class="tab card" hidden>
      <h2>⚙️ Configuração</h2>
      <div id="listaReservas"></div>
      <div class="space-top">
        <button id="btnReset" class="btn danger">Limpar dados</button>
        <div class="note">Dados salvos no seu dispositivo (localStorage)</div>
      </div>
    </section>
  </main>
  <script>
  // ======= Helpers =======
  const fmtBRL = (n) => (n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const parseN = (v) => Number(String(v).replace(',','.'))||0;
  const today = () => new Date();
  const getPeriod = (d) => {
    const date=new Date(d||today());
    return date.getFullYear()+"-"+String(date.getMonth()+1).padStart(2,'0');
  };

  // Corrige problema de datas (fuso local)
  function parseLocalDate(inputDate){
    const [y,m,d] = inputDate.split("-").map(Number);
    const now = new Date();
    return new Date(y, m-1, d, now.getHours(), now.getMinutes(), now.getSeconds());
  }

  // ======= Estado =======
  let state = JSON.parse(localStorage.getItem('fin-state')||'{}');
  if(!state.periodos) state={periodos:{},tipos:["Moradia","Transporte","Alimentação","Saúde","Serviços","Educação","Outros"], metas:[], notas:[]};
  if(!state.metas) state.metas=[];
  if(!state.notas) state.notas=[];
  let currentPeriod;
  function ensurePeriod(p){ if(!state.periodos[p]) state.periodos[p]={rendas:[],despesas:[],cartoes:[]}; }
  function save(){ localStorage.setItem('fin-state',JSON.stringify(state)); renderAll(); }

  // ======= Periodos =======
  function renderPeriods(){
    const sel=document.getElementById('periodSelect'); sel.innerHTML="";
    const ps=Object.keys(state.periodos).sort();
    ps.forEach(p=>{
      const opt=document.createElement('option');
      opt.value=p; opt.textContent=p; sel.appendChild(opt);
    });
    if(!currentPeriod){currentPeriod=getPeriod(); ensurePeriod(currentPeriod);}    
    if(!ps.includes(currentPeriod)){ensurePeriod(currentPeriod);}    
    sel.value=currentPeriod;
    sel.onchange=()=>{currentPeriod=sel.value; renderAll();};
  }

  // ======= Rendas =======
  document.getElementById('btnAddRenda').onclick=()=>{
    const nome=document.getElementById('rendaNome').value.trim();
    const valor=parseN(document.getElementById('rendaValor').value);
    const data=document.getElementById('rendaData').value;
    const meses=parseInt(document.getElementById('rendaRecorrente').value);
    if(!nome||!valor||!data){alert("Preencha os campos");return;}

    const d=parseLocalDate(data);
    const p=getPeriod(d);
    ensurePeriod(p);
    state.periodos[p].rendas.push({id:Date.now(),nome,valor,data:d.toISOString(),recorrente:meses>0});
    currentPeriod=p;

    if(meses>0){
      for(let i=1;i<meses;i++){
        let d2=new Date(d); d2.setMonth(d2.getMonth()+i);
        const pi=getPeriod(d2);
        ensurePeriod(pi);
        state.periodos[pi].rendas.push({id:Date.now()+i,nome,valor,data:d2.toISOString(),recorrente:true});
      }
    }
    document.getElementById('rendaNome').value="";
    document.getElementById('rendaValor').value="";
    document.getElementById('rendaData').value="";
    document.getElementById('rendaRecorrente').value="0";
    save();
  };
  function renderRenda(){
    ensurePeriod(currentPeriod);
    const tb=document.querySelector('#tblRenda tbody'); tb.innerHTML="";
    state.periodos[currentPeriod].rendas.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.nome}</td><td>${new Date(r.data).toLocaleDateString()}</td><td class="right">${fmtBRL(r.valor)}</td><td><button class="btn ghost">X</button></td>`;
      tr.querySelector('button').onclick=()=>{state.periodos[currentPeriod].rendas=state.periodos[currentPeriod].rendas.filter(x=>x.id!==r.id); save();};
      tb.appendChild(tr);
    });
  }

  // ======= Tipos =======
  function renderTipos(){
    const sel=document.getElementById('despTipo'); sel.innerHTML="";
    state.tipos.forEach(t=>{const o=document.createElement('option'); o.textContent=t; sel.appendChild(o);});
  }
  document.getElementById('btnAddTipo').onclick=()=>{
    const v=document.getElementById('novoTipo').value.trim();
    if(v){state.tipos.push(v); document.getElementById('novoTipo').value=""; save();}
  };

  // ======= Despesas =======
  document.getElementById('btnAddDesp').onclick=()=>{
    const nome=document.getElementById('despNome').value.trim();
    const valor=parseN(document.getElementById('despValor').value);
    const data=document.getElementById('despData').value;
    const tipo=document.getElementById('despTipo').value;
    const meses=parseInt(document.getElementById('despRecorrente').value);
    if(!nome||!valor||!data){alert("Preencha os campos");return;}

    const d=parseLocalDate(data);
    const p=getPeriod(d);
    ensurePeriod(p);
    state.periodos[p].despesas.push({id:Date.now(),nome,valor,data:d.toISOString(),tipo,recorrente:meses>0});
    currentPeriod=p;

    if(meses>0){
      for(let i=1;i<meses;i++){
        let d2=new Date(d); d2.setMonth(d2.getMonth()+i);
        const pi=getPeriod(d2);
        ensurePeriod(pi);
        state.periodos[pi].despesas.push({id:Date.now()+i,nome,valor,data:d2.toISOString(),tipo,recorrente:true});
      }
    }
    document.getElementById('despNome').value="";
    document.getElementById('despValor').value="";
    document.getElementById('despData').value="";
    document.getElementById('despRecorrente').value="0";
    save();
  };
  function renderDesp(){
    ensurePeriod(currentPeriod);
    const tb=document.querySelector('#tblDesp tbody'); tb.innerHTML="";
    state.periodos[currentPeriod].despesas.forEach(d=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${d.nome}</td><td>${new Date(d.data).toLocaleDateString()}</td><td>${d.tipo}</td><td class="right">${fmtBRL(d.valor)}</td><td><button class="btn ghost">X</button></td>`;
      tr.querySelector('button').onclick=()=>{state.periodos[currentPeriod].despesas=state.periodos[currentPeriod].despesas.filter(x=>x.id!==d.id); save();};
      tb.appendChild(tr);
    });
  }

  // ======= Cartões =======
  document.getElementById('btnAddCC').onclick=()=>{
    const nome=document.getElementById('ccNome').value.trim();
    const valor=parseN(document.getElementById('ccValor').value);
    const venc=document.getElementById('ccVenc').value;
    if(!nome||!valor||!venc){alert("Preencha os campos");return;}

    const d=parseLocalDate(venc);
    const p=getPeriod(d);
    ensurePeriod(p);
    state.periodos[p].cartoes.push({id:Date.now(),nome,valor,venc:d.toISOString()});
    currentPeriod=p;

    document.getElementById('ccNome').value="";
    document.getElementById('ccValor').value="";
    document.getElementById('ccVenc').value="";
    save();
  };
  function renderCC(){
    ensurePeriod(currentPeriod);
    const tb=document.querySelector('#tblCC tbody'); tb.innerHTML="";
    state.periodos[currentPeriod].cartoes.forEach(c=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${c.nome}</td><td>${new Date(c.venc).toLocaleDateString()}</td><td class="right">${fmtBRL(c.valor)}</td><td><button class="btn ghost">X</button></td>`;
      tr.querySelector('button').onclick=()=>{state.periodos[currentPeriod].cartoes=state.periodos[currentPeriod].cartoes.filter(x=>x.id!==c.id); save();};
      tb.appendChild(tr);
    });
  }

  // ======= Dashboard =======
  function renderDashboard(){
    ensurePeriod(currentPeriod);
    const rendas=state.periodos[currentPeriod].rendas||[];
    const despesas=state.periodos[currentPeriod].despesas||[];
    const cartoes=state.periodos[currentPeriod].cartoes||[];
    const totalR=rendas.reduce((s,x)=>s+x.valor,0);
    const totalD=despesas.reduce((s,x)=>s+x.valor,0);
    const totalC=cartoes.reduce((s,x)=>s+x.valor,0);
    const saldo=totalR;
    document.getElementById('kpiSaldo').textContent=fmtBRL(saldo);
    document.getElementById('kpiSobra').textContent=fmtBRL(saldo-totalD-totalC);
  

    // Corrigido: mostra próximo vencimento e total despesas
    const eventos=[...despesas.map(d=>({data:d.data,nome:d.nome})),...cartoes.map(c=>({data:c.venc,nome:c.nome}))];
    const futuros=eventos.filter(e=>new Date(e.data)>=today());
    futuros.sort((a,b)=>new Date(a.data)-new Date(b.data));

    const proximo = futuros.length ? new Date(futuros[0].data).toLocaleDateString()+" - "+futuros[0].nome : "—";
    const somadivt = totalD+totalC
    const resumo = `Próximo vencimento: ${proximo}`;
    const totaldiv = `R$ ${somadivt}`;
    document.getElementById('kpiVencimento').textContent=resumo;
    document.getElementById('kpisomadiv').textContent=totaldiv;

  }

  // ======= Metas =======
  function addMeta(){
    const desc = document.getElementById('metaDesc').value.trim();
    const alvo = parseN(document.getElementById('metaValor').value);
    if(!desc || !alvo){ alert('Informe descrição e valor da meta'); return; }
    state.metas.push({ id: Date.now(), desc, alvo, acumulado: 0 });
    document.getElementById('metaDesc').value='';
    document.getElementById('metaValor').value='';
    save();
  }
  document.getElementById('btnAddMeta').onclick = addMeta;

  function renderMetas(){
    const grid = document.getElementById('goalsGrid');
    grid.innerHTML='';
    state.metas.forEach(m=>{
      const pct = m.alvo>0 ? Math.min(100, Math.round((m.acumulado/m.alvo)*100)) : 0;
      let cls = 'p-red';
      if (pct>33 && pct<=77) cls='p-orange';
      else if (pct>77 && pct<100) cls='p-green';
      else if (pct>=100) cls='p-gold';

      const card = document.createElement('div');
      card.className='card goal-card';
      card.innerHTML = `
        <button class="goal-close" title="Excluir">×</button>
        <h3 style="margin:0 0 6px">${m.desc}</h3>
        <div class="goal-nums"><span>Alvo: <strong>${fmtBRL(m.alvo)}</strong></span><span>Acumulado: <strong>${fmtBRL(m.acumulado)}</strong></span></div>
        <div class="progress space-top"><span class="${cls}" style="width:${pct}%"></span></div>
        <div class="goal-nums" style="margin-top:6px"><span>${pct}%</span><span>Falta: <strong>${fmtBRL(Math.max(0,m.alvo-m.acumulado))}</strong></span></div>
        <div class="row" style="margin-top:10px">
          <div class="grow"><input type="number" step="0.01" placeholder="Valor" class="metaMov"></div>
          <button class="btn">+ Adicionar</button>
          <button class="btn warn">- Retirar</button>
        </div>
      `;

      // Excluir meta
      card.querySelector('.goal-close').onclick = ()=>{
        if(confirm('Deseja realmente excluir esta meta?')){
          state.metas = state.metas.filter(x=>x.id!==m.id); save();
        }
      };
      // Adicionar/Retirar valores
      const input = card.querySelector('.metaMov');
      card.querySelectorAll('button.btn').forEach((b,i)=>{
        b.onclick = ()=>{
          const v = parseN(input.value);
          if(!v){ alert('Informe um valor'); return; }
          if(i===0){ // adicionar
            m.acumulado = Math.max(0, m.acumulado + v);
          } else { // retirar
            m.acumulado = Math.max(0, m.acumulado - v);
          }
          input.value='';
          save();
        };
      });

      grid.appendChild(card);
    });
  }

  // ======= Listas (post-it) =======
  function novaNota(){
    state.notas.push({ id: Date.now(), texto: '', done: false });
    save();
  }
  document.getElementById('btnNovaNota').onclick = novaNota;

  function renderNotas() {
  const grid = document.getElementById('notesGrid');

  // Salvar foco e posição do cursor antes de recriar
  const active = document.activeElement;
  let caretPos = null;
  let activeId = null;
  if (active && active.classList.contains("note-text")) {
    caretPos = active.selectionStart;
    activeId = active.dataset.id;
  }

  grid.innerHTML = '';
  state.notas.forEach(n => {
    const el = document.createElement('div');
    el.className = 'note-item' + (n.done ? ' done' : '');
    el.innerHTML = `
      <button class="note-delete">×</button>
      <textarea class="note-text" placeholder="Escreva sua anotação..." data-id="${n.id}"></textarea>
      <div class="note-footer"><input type="checkbox" class="note-done"></div>
    `;
    const txt = el.querySelector('.note-text');
    const chk = el.querySelector('.note-done');
    txt.value = n.texto;
    chk.checked = n.done;

    // Salvar texto ao digitar
    txt.addEventListener('input', () => { 
      n.texto = txt.value; 
      save(); 
    });
    // Toggle done
    chk.addEventListener('change', () => { 
      n.done = chk.checked; 
      save(); 
    });
    // Excluir com confirmação somente se houver texto
    el.querySelector('.note-delete').onclick = () => {
      if (n.texto.trim().length > 0) {
        if (!confirm('Esta nota possui conteúdo. Deseja realmente excluir?')) return;
      }
      state.notas = state.notas.filter(x => x.id !== n.id); 
      save();
    };

    grid.appendChild(el);

    // Restaurar foco no textarea que estava ativo
    if (activeId && n.id == activeId) {
      txt.focus();
      if (caretPos !== null) {
        txt.setSelectionRange(caretPos, caretPos);
      }
    }
  });
}


  // ======= Config =======
  document.getElementById('btnReset').onclick=()=>{ 
    if(confirm("Apagar todos os dados?")){
      localStorage.removeItem('fin-state'); 
      location.reload();
    } 
  };

  // ======= Tabs =======
  const tabNames = [
    ["dashboard", "Dashboard"],
    ["metas", "Metas"],
    ["listas", "Post-it"],
    ["renda", "Renda"],
    ["despesas", "Despesas"],
    ["cartoes", "Cartões"],
    ["relatorios", "⚙️"]   // ícone no menu
  ];
  function renderTabs(){
    const nav=document.getElementById('tabs'); nav.innerHTML="";
    tabNames.forEach(([id,label],i)=>{
      const b=document.createElement('button'); 
      b.textContent=label; 
      if(i==0) b.classList.add('active');
      b.onclick=()=>{
        document.querySelectorAll('.tab').forEach(t=>t.hidden=true); 
        document.getElementById('tab-'+id).hidden=false; 
        document.querySelectorAll('nav button').forEach(x=>x.classList.remove('active')); 
        b.classList.add('active');
      };
      nav.appendChild(b);
    });
    document.getElementById('tab-dashboard').hidden=false;
  }

  // ======= Tema =======
  const themeToggle=document.getElementById('themeToggle');
  const themeIcon=document.getElementById('themeIcon');
  function applyTheme(){
    if(localStorage.getItem('theme')==='light'){
      document.body.classList.add('light');
      themeToggle.checked=false;
      themeIcon.textContent='🌞';
    } else {
      document.body.classList.remove('light');
      themeToggle.checked=true;
      themeIcon.textContent='🌙';
    }
  }
  themeToggle.onchange=()=>{localStorage.setItem('theme', themeToggle.checked?'dark':'light'); applyTheme();};

  // ======= Render All =======
  function renderAll(){ 
    renderPeriods(); 
    renderRenda(); 
    renderDesp(); 
    renderCC(); 
    renderDashboard(); 
    renderTipos(); 
    renderMetas();
    renderNotas();
  }

  // init
  renderTabs(); 
  applyTheme(); 
  renderAll();
  </script>
  <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
      .then(() => console.log("Service Worker registrado"));
  }
  </script>
</body>
</html>

