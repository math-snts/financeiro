<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>💰 Meu Financeiro Pro - Dashboard Inteligente</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --muted: #334155;
      --text: #f1f5f9;
      --text-dim: #94a3b8;
      --accent: #10b981;
      --accent-2: #3b82f6;
      --danger: #ef4444;
      --warn: #f59e0b;
      --success: #22c55e;
      --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      --shadow-lg: 0 35px 60px -12px rgba(0, 0, 0, 0.35);
      --radius: 16px;
      --radius-lg: 20px;
    }

    body.light {
      --bg: #f8fafc;
      --card: #ffffff;
      --muted: #e2e8f0;
      --text: #0f172a;
      --text-dim: #64748b;
      --accent: #10b981;
      --accent-2: #2563eb;
      --danger: #dc2626;
      --warn: #d97706;
      --success: #16a34a;
      --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    * {
      box-sizing: border-box;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    html, body {
      height: 100%;
      scroll-behavior: smooth;
    }

    body {
      margin: 0;
      background: linear-gradient(135deg, var(--bg) 0%, #1e293b 100%);
      background-attachment: fixed;
      color: var(--text);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      line-height: 1.6;
      overflow-x: hidden;
    }

    body.light {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    }

    /* Loading Animation */
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s ease;
    }

    .loading.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 3px solid var(--muted);
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Header */
    header {
      position: sticky;
      top: 0;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(20px) saturate(180%);
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
      z-index: 100;
      box-shadow: var(--shadow);
    }

    body.light header {
      background: rgba(248, 250, 252, 0.95);
      border-bottom-color: rgba(100, 116, 139, 0.1);
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem 1.5rem;
      width: 100%;
      box-sizing: border-box;
    }

    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.5rem;
      font-weight: 800;
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    /* Period Select - Mês atual primeiro */
    .period-dropdown {
      position: relative;
      display: inline-block;
    }

    .period-select {
      background: var(--card);
      border: 1px solid var(--muted);
      color: var(--text);
      padding: 0.75rem 1.5rem 0.75rem 1rem;
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
      min-width: 180px;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
      padding-right: 2.5rem;
    }

    .period-select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .period-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--card);
      border: 1px solid var(--muted);
      border-top: none;
      border-radius: 0 0 var(--radius-lg) var(--radius-lg);
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.2s ease;
      box-shadow: var(--shadow-lg);
    }

    .period-list.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .period-option {
      padding: 0.75rem 1rem;
      cursor: pointer;
      border-bottom: 1px solid var(--muted);
      font-size: 0.875rem;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .period-option:hover,
    .period-option.active {
      background: rgba(16, 185, 129, 0.1);
      color: var(--accent);
    }

    .period-option.current {
      background: var(--accent);
      color: white;
      font-weight: 600;
    }

    .period-option.current:hover {
      background: var(--accent);
      color: white;
    }

    .period-option:last-child {
      border-bottom: none;
    }

    .period-option i {
      font-size: 0.75rem;
      opacity: 0.5;
    }

    .period-option.current i {
      opacity: 1;
    }

    .theme-toggle {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
    }

    .theme-toggle input {
      display: none;
    }

    .slider {
      width: 48px;
      height: 26px;
      background: var(--muted);
      border-radius: 50px;
      position: relative;
      transition: all 0.3s ease;
    }

    .slider::before {
      content: "";
      position: absolute;
      top: 2px;
      left: 2px;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: white;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    input:checked + .slider {
      background: var(--accent);
    }

    input:checked + .slider::before {
      transform: translateX(22px);
    }

    /* Side Navigation */
    .side-nav {
      position: fixed;
      top: 0;
      right: -300px;
      width: 300px;
      height: 100vh;
      background: var(--card);
      border-left: 1px solid var(--muted);
      z-index: 200;
      transition: right 0.3s ease;
      overflow-y: auto;
      padding: 2rem 0;
    }

    .side-nav.open {
      right: 0;
    }

    .nav-toggle {
      background: var(--accent);
      border: none;
      color: white;
      padding: 0.75rem;
      border-radius: 50px;
      cursor: pointer;
      font-size: 1rem;
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 250;
      box-shadow: var(--shadow);
    }

    .nav-menu {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding: 1rem;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 500;
      font-size: 0.875rem;
      transition: all 0.2s ease;
      color: var(--text);
      text-decoration: none;
      border: 1px solid transparent;
    }

    .nav-item:hover {
      background: rgba(16, 185, 129, 0.1);
      border-color: var(--accent);
      transform: translateX(4px);
    }

    .nav-item.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .nav-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 150;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .nav-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    /* Main Content - Centralizado e Responsivo */
    main {
      max-width: 100%;
      margin: 2rem auto;
      padding: 0 1.5rem 4rem;
      min-height: calc(100vh - 200px);
      width: 100%;
      box-sizing: border-box;
    }

    /* Container wrapper para centralização */
    .content-wrapper {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    /* All Tabs Hidden by Default */
    .tab {
      display: none;
    }

    .tab.active {
      display: block;
      animation: fadeInUp 0.6s ease forwards;
    }

    /* Welcome Screen / Onboarding */
    .welcome-screen {
      text-align: center;
      padding: 3rem 2rem;
      background: var(--gradient);
      border-radius: var(--radius-lg);
      margin-bottom: 2rem;
      color: white;
      position: relative;
      overflow: hidden;
    }

    .welcome-screen::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.05"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
      opacity: 0.3;
    }

    .welcome-content {
      position: relative;
      z-index: 1;
    }

    .welcome-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.9;
    }

    .welcome-title {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
    }

    .welcome-subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
      margin-bottom: 2rem;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }

    .progress-steps {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .step {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      opacity: 0.7;
    }

    .step.completed {
      opacity: 1;
      color: var(--success);
    }

    .step-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
    }

    .step.completed .step-icon {
      background: var(--success);
      color: white;
    }

    .skip-onboarding {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }

    .skip-onboarding:hover {
      border-color: white;
      background: rgba(255, 255, 255, 0.1);
    }

    /* Cards */
    .card {
      background: var(--card);
      border: 1px solid var(--muted);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      margin-bottom: 1.5rem;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .card:hover::before {
      opacity: 1;
    }

    .card h2 {
      margin: 0 0 1rem;
      font-size: 1.25rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card h3 {
      margin: 0 0 0.75rem;
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text);
    }

    /* KPI Cards */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin: 1.5rem 0;
    }

    .kpi-card {
      text-align: center;
      padding: 2rem;
      border-radius: var(--radius-lg);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .kpi-card:hover {
      transform: translateY(-4px);
    }

    .kpi-card.balance {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
    }

    .kpi-card.expenses {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
    }

    .kpi-card.leftover {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
    }

    .kpi-value {
      font-size: 3rem;
      font-weight: 800;
      margin: 0.5rem 0;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      line-height: 1;
    }

    .kpi-label {
      color: rgba(255,255,255,0.8);
      font-size: 0.875rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .kpi-trend {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
      font-size: 0.75rem;
      margin-top: 0.5rem;
      opacity: 0.8;
    }

    /* Quick Actions */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin: 2rem 0;
    }

    .quick-action {
      background: var(--card);
      border: 2px solid var(--muted);
      border-radius: var(--radius);
      padding: 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }

    .quick-action:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .quick-action i {
      font-size: 2rem;
      color: var(--accent);
    }

    .quick-action-label {
      font-weight: 600;
      color: var(--text);
      font-size: 0.875rem;
    }

    /* Forms */
    .form-grid {
      display: grid;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      align-items: end;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      position: relative;
    }

    label {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Help Popups - Pequenos e Elegantes */
    .help-trigger {
      background: var(--muted);
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      cursor: help;
      font-weight: bold;
      transition: all 0.2s ease;
      border: none;
      position: relative;
    }

    .help-trigger:hover {
      background: var(--accent);
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .help-popup {
      position: absolute;
      top: -10px;
      right: -10px;
      background: var(--card);
      color: var(--text);
      padding: 1rem;
      border-radius: var(--radius);
      font-size: 0.8rem;
      max-width: 280px;
      width: max-content;
      box-shadow: var(--shadow-lg);
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px) scale(0.95);
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* O botão .help-trigger fica dentro do label; o .help-popup é irmão do label.
        Mostrar popup quando o label é hover ou possui foco interno (acessibilidade),
        ou quando a classe .show for aplicada via JS (útil em touch). */
    label:hover + .help-popup,
    label:focus-within + .help-popup,
    .help-popup.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0) scale(1);
    }

    .help-popup::before {
      content: '';
      position: absolute;
      top: 100%;
      right: 16px;
      width: 0;
      height: 0;
      border: 8px solid transparent;
      border-top-color: var(--muted);
      z-index: 1;
    }

    .help-popup::after {
      content: '';
      position: absolute;
      top: 100%;
      right: 15px;
      width: 0;
      height: 0;
      border: 7px solid transparent;
      border-top-color: var(--card);
      z-index: 2;
    }

    .help-icon {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      width: 16px;
      height: 16px;
      background: var(--accent);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6rem;
      cursor: pointer;
    }

    .help-icon:hover {
      background: var(--success);
      transform: scale(1.1);
    }

    input, select, textarea {
      width: 100%;
      padding: 0.875rem 1rem;
      background: var(--bg);
      border: 2px solid var(--muted);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 1rem;
      transition: all 0.2s ease;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
      transform: translateY(-1px);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
    }

    /* Buttons */
    .btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.875rem 1.5rem;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
      font-size: 0.875rem;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn.ghost {
      background: transparent;
      border: 2px solid var(--muted);
      color: var(--text);
    }

    .btn.ghost:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(16, 185, 129, 0.1);
    }

    .btn.danger {
      background: var(--danger);
    }

    .btn.danger:hover {
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
    }

    .btn.success {
      background: var(--success);
    }

    .btn.primary {
      background: var(--accent-2);
    }

    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.75rem;
      min-width: auto;
    }

    /* Tables */
    .table-container {
      overflow-x: auto;
      border-radius: var(--radius);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      margin-top: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card);
    }

    th, td {
      padding: 1rem 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--muted);
    }

    th {
      color: var(--text-dim);
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      background: rgba(15, 23, 42, 0.5);
      position: sticky;
      top: 0;
    }

    body.light th {
      background: rgba(248, 250, 252, 0.5);
    }

    td {
      font-size: 0.875rem;
    }

    .text-right {
      text-align: right;
    }

    /* Tags */
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.75rem;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 600;
      border: 1px solid var(--muted);
      color: var(--text);
      background: var(--bg);
    }

    .tag.expense {
      border-color: var(--danger);
      color: var(--danger);
      background: rgba(239, 68, 68, 0.1);
    }

    .tag.income {
      border-color: var(--success);
      color: var(--success);
      background: rgba(34, 197, 94, 0.1);
    }

    /* Goals Section */
    .goals-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    .goal-card {
      position: relative;
      background: var(--card);
      border: 1px solid var(--muted);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }

    .goal-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px -8px rgba(0, 0, 0, 0.2);
    }

    .goal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .goal-close {
      background: transparent;
      border: none;
      color: var(--text-dim);
      font-size: 1.25rem;
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .goal-close:hover {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }

    .progress-bar {
      height: 8px;
      background: var(--muted);
      border-radius: 4px;
      overflow: hidden;
      margin: 1rem 0;
    }

    .progress-fill {
      height: 100%;
      transition: width 0.8s ease;
      border-radius: 4px;
    }

    .progress-red { background: var(--danger); }
    .progress-orange { background: var(--warn); }
    .progress-green { background: var(--success); }
    .progress-gold { 
      background: linear-gradient(90deg, var(--warn), #fbbf24);
    }

    .goal-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin: 1rem 0;
      font-size: 0.875rem;
      color: var(--text-dim);
    }

    .goal-stats strong {
      color: var(--text);
      font-weight: 700;
    }

    .goal-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .goal-input {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid var(--muted);
      border-radius: var(--radius);
      font-size: 0.875rem;
    }

    /* Notes Section */
    .notes-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .notes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-top: 1rem;
    }

    .note-card {
      position: relative;
      background: linear-gradient(135deg, #fef08a, #fde047);
      color: #1f2937;
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow-lg);
      min-height: 180px;
      transition: all 0.3s ease;
      contain: layout style;
    }

    body.light .note-card {
      background: linear-gradient(135deg, #fef08a, #fde047);
    }

    .note-card:hover {
      transform: translateY(-2px) rotate(1deg);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
    }

    .note-card.done {
      opacity: 0.7;
      transform: scale(0.98);
    }

    .note-delete {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: rgba(239, 68, 68, 0.2);
      border: none;
      color: #dc2626;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }

    .note-delete:hover {
      background: var(--danger);
      color: white;
      transform: scale(1.1);
    }

    .note-content {
      min-height: 120px;
      border: none;
      background: transparent;
      color: inherit;
      font: inherit;
      resize: none;
      width: 100%;
      outline: none;
      padding: 0;
      margin: 0 0 1rem;
      line-height: 1.5;
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
      contain: content;
    }

    .note-content:focus {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      padding: 2px 4px;
      box-shadow: inset 0 0 0 1px rgba(16, 185, 129, 0.3);
    }

    .note-card.done .note-content {
      text-decoration: line-through;
      opacity: 0.8;
    }

    .note-footer {
      position: absolute;
      bottom: 0.5rem;
      right: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .note-checkbox {
      width: 20px;
      height: 20px;
      accent-color: var(--success);
    }

    /* Empty States */
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-dim);
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .empty-state h3 {
      margin: 0 0 0.5rem;
      color: var(--text);
      font-size: 1.25rem;
    }

    .empty-state p {
      margin: 0 0 2rem;
      opacity: 0.8;
    }

    .empty-action {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.875rem 2rem;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }

    .empty-action:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
    }

    /* Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Utility Classes */
    .space-top { margin-top: 1rem; }
    .space-bottom { margin-bottom: 1rem; }
    .text-muted { color: var(--text-dim); }
    .text-small { font-size: 0.75rem; }
    .font-bold { font-weight: 700; }
    .hidden { display: none !important; }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .grid {
      display: grid;
      gap: 1.5rem;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--muted);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent-2);
    }

    /* Centralização para Desktop - ADICIONADO */
    @media screen and (min-width: 768px) {
      .content-wrapper {
        padding: 0 1.5rem;
      }
      
      .wrap {
        padding: 1rem 2rem;
      }
      
      main {
        padding: 0 2rem 4rem;
      }
    }

    @media screen and (min-width: 1024px) {
      .content-wrapper {
        max-width: 1200px;
        padding: 0 2rem;
        margin: 0 auto;
      }
      
      .wrap {
        max-width: 1200px;
        padding: 1rem 2rem;
        margin: 0 auto;
      }
      
      main {
        max-width: 1200px;
        padding: 0 2rem 4rem;
        margin: 2rem auto;
      }
    }

    @media screen and (min-width: 1440px) {
      .content-wrapper {
        max-width: 1400px;
        padding: 0 3rem;
      }
      
      .wrap {
        max-width: 1400px;
        padding: 1rem 3rem;
      }
      
      main {
        max-width: 1400px;
        padding: 0 3rem 4rem;
        margin: 2rem auto;
      }
    }

    /* Para telas ultra-wide */
    @media screen and (min-width: 1920px) {
      .content-wrapper {
        max-width: 1600px;
        padding: 0 4rem;
      }
      
      .wrap {
        max-width: 1600px;
        padding: 1rem 4rem;
      }
      
      main {
        max-width: 1600px;
        padding: 0 4rem 4rem;
        margin: 2rem auto;
      }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .kpi-grid {
        grid-template-columns: 1fr;
      }
      
      .goals-grid, .notes-grid {
        grid-template-columns: 1fr;
      }
      
      .header-row {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
      }
      
      .nav-toggle {
        top: 0.5rem;
        right: 0.5rem;
      }
      
      .side-nav {
        width: 100%;
        right: -100%;
      }
      
      .period-select {
        min-width: 140px;
      }
      
      .content-wrapper {
        padding: 0 1rem;
      }
      
      .wrap {
        padding: 1rem;
      }
      
      main {
        padding: 0 1rem 4rem;
        margin: 1rem auto;
      }
    }

    @media (max-width: 480px) {
      .welcome-screen {
        padding: 2rem 1rem;
      }
      
      .welcome-title {
        font-size: 1.5rem;
      }
      
      .kpi-value {
        font-size: 2.5rem;
      }
      
      .card {
        padding: 1rem;
      }
    }
  </style>
</head>

<body>
  <!-- Loading Screen -->
  <div class="loading" id="loading">
    <div class="spinner"></div>
  </div>

  <!-- Navigation Toggle -->
  <button class="nav-toggle" id="navToggle">
    <i class="fas fa-bars"></i>
  </button>

  <!-- Navigation Overlay -->
  <div class="nav-overlay" id="navOverlay"></div>

  <!-- Side Navigation -->
  <nav class="side-nav" id="sideNav">
    <div class="nav-menu">
      <a href="#" class="nav-item active" data-tab="dashboard">
        <i class="fas fa-chart-line"></i>
        Dashboard
      </a>
      <a href="#" class="nav-item" data-tab="renda">
        <i class="fas fa-arrow-up"></i>
        Renda
      </a>
      <a href="#" class="nav-item" data-tab="despesas">
        <i class="fas fa-arrow-down"></i>
        Despesas
      </a>
      <a href="#" class="nav-item" data-tab="cartoes">
        <i class="fas fa-credit-card"></i>
        Cartões
      </a>
      <a href="#" class="nav-item" data-tab="metas">
        <i class="fas fa-bullseye"></i>
        Metas
      </a>
      <a href="#" class="nav-item" data-tab="listas">
        <i class="fas fa-sticky-note"></i>
        Post-its
      </a>
      <a href="#" class="nav-item" data-tab="relatorios">
        <i class="fas fa-cog"></i>
        Configurações
      </a>
    </div>
  </nav>

  <header>
    <div class="wrap">
      <div class="header-row">
        <div class="logo">
          <i class="fas fa-wallet"></i>
          Meu Financeiro Pro
        </div>
        <div class="header-actions">
          <div class="period-dropdown">
            <div class="period-select" id="periodSelect" onclick="togglePeriodList()">
              <span id="currentPeriodText">Carregando...</span>
            </div>
            <div class="period-list" id="periodList"></div>
          </div>
          <label class="theme-toggle">
            <i id="themeIcon" class="fas fa-sun"></i>
            <input type="checkbox" id="themeToggle">
            <span class="slider"></span>
          </label>
        </div>
      </div>
    </div>
  </header>

  <main class="content-wrapper">
    <!-- Welcome Screen / Onboarding -->
    <section id="welcomeScreen" class="welcome-screen animate-fade-in" style="display: none;">
      <div class="welcome-content">
        <div class="welcome-icon">
          <i class="fas fa-rocket"></i>
        </div>
        <h1 class="welcome-title">Bem-vindo ao seu Financeiro Inteligente! 🚀</h1>
        <p class="welcome-subtitle">
          Vamos configurar seu controle financeiro em 3 passos simples. Você verá seus dados em tempo real assim que terminar!
        </p>
        
        <div class="progress-steps">
          <div class="step" id="step1">
            <div class="step-icon">1</div>
            <span>Adicionar sua primeira renda</span>
          </div>
          <div class="step" id="step2">
            <div class="step-icon">2</div>
            <span>Registrar uma despesa</span>
          </div>
          <div class="step" id="step3">
            <div class="step-icon">3</div>
            <span>Definir uma meta</span>
          </div>
        </div>
        
        <button id="startOnboarding" class="btn success">
          <i class="fas fa-play"></i> Começar Agora
        </button>
        <button id="skipOnboarding" class="skip-onboarding space-top">
          Pular e ver dados →
        </button>
      </div>
    </section>

    <!-- DASHBOARD - Agora como aba normal -->
    <section id="tab-dashboard" class="tab card animate-fade-in" style="display: none;">
      <h2><i class="fas fa-chart-line"></i> Dashboard</h2>
      
      <!-- KPIs Principais -->
      <div class="kpi-grid">
        <div class="kpi-card balance">
          <div class="kpi-label">Saldo Previsto</div>
          <div class="kpi-value" id="kpiSaldo">R$ 0,00</div>
          <div class="text-muted text-small">Total de entradas</div>
          <div class="kpi-trend">
            <i class="fas fa-arrow-up"></i>
            <span>+12% vs mês anterior</span>
          </div>
        </div>
        <div class="kpi-card expenses">
          <div class="kpi-label">Total Despesas</div>
          <div class="kpi-value" id="kpisomadiv">R$ 0,00</div>
          <div class="text-muted text-small">Despesas + cartões</div>
          <div class="kpi-trend">
            <i class="fas fa-arrow-down"></i>
            <span>Alerta: próximo vencimento</span>
          </div>
        </div>
        <div class="kpi-card leftover">
          <div class="kpi-label">Sobra Mensal</div>
          <div class="kpi-value" id="kpiSobra">R$ 0,00</div>
          <div class="text-muted text-small">Saldo disponível</div>
          <div class="kpi-trend" id="kpiTrend">
            <i class="fas fa-chart-line"></i>
            <span id="kpiTrendText">Estável</span>
          </div>
        </div>
      </div>
      
      <!-- Informações Rápidas -->
      <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1.5rem;">
        <div class="card">
          <h3><i class="fas fa-calendar-alt"></i> Próximo Vencimento</h3>
          <div id="kpiVencimento" class="text-muted font-bold" style="font-size: 1.1rem;">—</div>
          <p class="text-small text-muted">Fique de olho nas datas importantes</p>
        </div>
        <div class="card">
          <h3><i class="fas fa-trending-up"></i> Economia do Mês</h3>
          <div id="kpiEconomia" class="text-muted font-bold" style="font-size: 1.1rem;">R$ 0,00</div>
          <p class="text-small text-muted">Comparado ao mês anterior</p>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions">
        <div class="quick-action" data-tab="renda" onclick="navigateToTab('renda')">
          <i class="fas fa-plus-circle"></i>
          <div class="quick-action-label">Adicionar Renda</div>
        </div>
        <div class="quick-action" data-tab="despesas" onclick="navigateToTab('despesas')">
          <i class="fas fa-minus-circle"></i>
          <div class="quick-action-label">Nova Despesa</div>
        </div>
        <div class="quick-action" data-tab="cartoes" onclick="navigateToTab('cartoes')">
          <i class="fas fa-credit-card"></i>
          <div class="quick-action-label">Gasto no Cartão</div>
        </div>
        <div class="quick-action" data-tab="metas" onclick="navigateToTab('metas')">
          <i class="fas fa-bullseye"></i>
          <div class="quick-action-label">Nova Meta</div>
        </div>
      </div>

      <!-- Resumo das Transações Recentes -->
      <div class="card">
        <h2><i class="fas fa-list"></i> Transações Recentes</h2>
        <div class="table-container">
          <table id="tblRecentes">
            <thead>
              <tr>
                <th><i class="fas fa-tag"></i> Descrição</th>
                <th><i class="fas fa-calendar"></i> Data</th>
                <th class="text-right"><i class="fas fa-money-bill-wave"></i> Valor</th>
                <th class="text-right"><i class="fas fa-cog"></i></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        
        <div id="emptyRecentes" class="empty-state" style="display: none;">
          <i class="fas fa-inbox"></i>
          <h3>Nenhuma transação ainda</h3>
          <p>Use os botões rápidos acima para começar!</p>
          <button class="empty-action" onclick="navigateToTab('renda')">
            <i class="fas fa-plus"></i> Primeira Renda
          </button>
        </div>
      </div>
    </section>

    <!-- RENDA -->
    <section id="tab-renda" class="tab card animate-fade-in" style="display: none;">
      <h2><i class="fas fa-arrow-up"></i> Renda</h2>
      <div class="form-grid">
        <div class="form-row">
          <div class="form-group">
            <label>
              Descrição
              <button class="help-trigger" type="button">
                <i class="fas fa-question-circle"></i>
              </button>
            </label>
            <div class="help-popup">
              <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent);">Como funciona</div>
              <div>Nome da fonte de renda (Salário, Freelance, Aluguel, etc.).</div>
              <div class="help-icon" onclick="this.parentElement.style.display='none'" title="Fechar">
                <i class="fas fa-times"></i>
              </div>
            </div>
            <input id="rendaNome" placeholder="Salário, Freelance, etc..." required>
          </div>
          <div class="form-group">
            <label>
              Valor
              <button class="help-trigger" type="button">
                <i class="fas fa-question-circle"></i>
              </button>
            </label>
            <div class="help-popup">
              <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent);">Dica importante</div>
              <div>Use o valor líquido recebido (após impostos e descontos). Use vírgula para centavos.</div>
              <div class="help-icon" onclick="this.parentElement.style.display='none'" title="Fechar">
                <i class="fas fa-times"></i>
              </div>
            </div>
            <input id="rendaValor" type="number" step="0.01" placeholder="0,00" required>
          </div>
          <div class="form-group">
            <label>
              Data de Recebimento
              <button class="help-trigger" type="button">
                <i class="fas fa-question-circle"></i>
              </button>
            </label>
            <div class="help-popup">
              <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent);">Por que isso importa</div>
              <div>Data em que o dinheiro realmente entra na conta. Ajuda no planejamento mensal.</div>
              <div class="help-icon" onclick="this.parentElement.style.display='none'" title="Fechar">
                <i class="fas fa-times"></i>
              </div>
            </div>
            <input id="rendaData" type="date" required>
          </div>
          <div class="form-group">
            <label>
              Recorrência
              <button class="help-trigger" type="button">
                <i class="fas fa-question-circle"></i>
              </button>
            </label>
            <div class="help-popup">
              <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent);">Automatize seu controle</div>
              <div>Se é uma renda que se repete regularmente, o sistema criará entradas automáticas para os próximos períodos.</div>
              <div class="help-icon" onclick="this.parentElement.style.display='none'" title="Fechar">
                <i class="fas fa-times"></i>
              </div>
            </div>
            <select id="rendaRecorrente">
              <option value="0">Única vez</option>
              <option value="1">Mensal</option>
              <option value="3">Trimestral</option>
              <option value="6">Semestral</option>
              <option value="12">Anual</option>
            </select>
          </div>
          <div class="form-group" style="align-self: end;">
            <button id="btnAddRenda" class="btn primary">
              <i class="fas fa-plus"></i> Adicionar Renda
            </button>
          </div>
        </div>
      </div>
      
      <div class="table-container space-top">
        <table id="tblRenda">
          <thead>
            <tr>
              <th><i class="fas fa-tag"></i> Descrição</th>
              <th><i class="fas fa-calendar"></i> Data</th>
              <th class="text-right"><i class="fas fa-money-bill-wave"></i> Valor</th>
              <th class="text-right"><i class="fas fa-cog"></i></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
      <div id="emptyRenda" class="empty-state">
        <i class="fas fa-arrow-up"></i>
        <h3>Nenhuma renda registrada</h3>
        <p>Adicione sua primeira entrada de renda para começar a ver seu saldo crescer!</p>
        <button class="empty-action" onclick="document.getElementById('rendaNome').focus()">
          <i class="fas fa-plus"></i> Adicionar Primeira Renda
        </button>
      </div>
    </section>

    <!-- DESPESAS -->
    <section id="tab-despesas" class="tab card animate-fade-in" style="display: none;">
      <h2><i class="fas fa-arrow-down"></i> Despesas</h2>
      <div class="form-grid">
        <div class="form-row">
          <div class="form-group">
            <label>
              Descrição
              <button class="help-trigger" type="button">
                <i class="fas fa-question-circle"></i>
              </button>
            </label>
            <div class="help-popup">
              <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent);">Seja específico</div>
              <div>O que você gastou (conta de luz, supermercado, Netflix, etc.). Detalhes ajudam na análise.</div>
              <div class="help-icon" onclick="this.parentElement.style.display='none'" title="Fechar">
                <i class="fas fa-times"></i>
              </div>
            </div>
            <input id="despNome" placeholder="Conta de luz, supermercado..." required>
          </div>
          <div class="form-group">
            <label>
              Valor
              <button class="help-trigger" type="button">
                <i class="fas fa-question-circle"></i>
              </button>
            </label>
            <div class="help-popup">
              <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent);">Precisão conta</div>
              <div>Valor exato do gasto. Use vírgula para centavos. Inclua tudo, até os pequenos gastos.</div>
              <div class="help-icon" onclick="this.parentElement.style.display='none'" title="Fechar">
                <i class="fas fa-times"></i>
              </div>
            </div>
            <input id="despValor" type="number" step="0.01" placeholder="0,00" required>
          </div>
          <div class="form-group">
            <label>
              Vencimento
              <button class="help-trigger" type="button">
                <i class="fas fa-question-circle"></i>
              </button>
            </label>
            <div class="help-popup">
              <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent);">Evite multas</div>
              <div>Data limite para pagamento. O sistema alertará sobre vencimentos próximos para evitar juros.</div>
              <div class="help-icon" onclick="this.parentElement.style.display='none'" title="Fechar">
                <i class="fas fa-times"></i>
              </div>
            </div>
            <input id="despData" type="date" required>
          </div>
          <div class="form-group">
            <label>
              Categoria
              <button class="help-trigger" type="button">
                <i class="fas fa-question-circle"></i>
              </button>
            </label>
            <div class="help-popup">
              <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent);">Organize melhor</div>
              <div>Ajuda a organizar e analisar seus gastos por tipo. Você pode criar novas categorias abaixo.</div>
              <div class="help-icon" onclick="this.parentElement.style.display='none'" title="Fechar">
                <i class="fas fa-times"></i>
              </div>
            </div>
            <select id="despTipo" required></select>
          </div>
          <div class="form-group">
            <label>
              Nova Categoria
              <button class="help-trigger" type="button">
                <i class="fas fa-question-circle"></i>
              </button>
            </label>
            <div class="help-popup">
              <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent);">Personalize</div>
              <div>Crie categorias específicas para seus gastos (ex: "Delivery", "Pet Shop", "Cursos").</div>
              <div class="help-icon" onclick="this.parentElement.style.display='none'" title="Fechar">
                <i class="fas fa-times"></i>
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <input id="novoTipo" placeholder="Ex: Lazer" style="flex: 1;">
              <button id="btnAddTipo" class="btn ghost btn-small">
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>
          <div class="form-group">
            <label>
              Recorrência
              <button class="help-trigger" type="button">
                <i class="fas fa-question-circle"></i>
              </button>
            </label>
            <div class="help-popup">
              <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent);">Não se preocupe em lembrar</div>
              <div>Se é um gasto que se repete (aluguel, internet, academia), o sistema criará automaticamente para os próximos meses.</div>
              <div class="help-icon" onclick="this.parentElement.style.display='none'" title="Fechar">
                <i class="fas fa-times"></i>
              </div>
            </div>
            <select id="despRecorrente">
              <option value="0">Única vez</option>
              <option value="1">Mensal</option>
              <option value="3">Trimestral</option>
              <option value="6">Semestral</option>
              <option value="12">Anual</option>
            </select>
          </div>
          <div class="form-group" style="align-self: end;">
            <button id="btnAddDesp" class="btn danger">
              <i class="fas fa-minus"></i> Registrar Despesa
            </button>
          </div>
        </div>
      </div>
      
      <div class="table-container space-top">
        <table id="tblDesp">
          <thead>
            <tr>
              <th><i class="fas fa-tag"></i> Descrição</th>
              <th><i class="fas fa-calendar"></i> Data</th>
              <th><i class="fas fa-folder"></i> Categoria</th>
              <th class="text-right"><i class="fas fa-money-bill-wave"></i> Valor</th>
              <th class="text-right"><i class="fas fa-cog"></i></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
      <div id="emptyDesp" class="empty-state">
        <i class="fas fa-arrow-down"></i>
        <h3>Nenhuma despesa registrada</h3>
        <p>Registre suas despesas para ter controle total do seu orçamento!</p>
        <button class="empty-action" onclick="document.getElementById('despNome').focus()">
          <i class="fas fa-plus"></i> Primeira Despesa
        </button>
      </div>
    </section>

    <!-- CARTÕES -->
    <section id="tab-cartoes" class="tab card animate-fade-in" style="display: none;">
      <h2><i class="fas fa-credit-card"></i> Cartões</h2>
      <div class="form-grid">
        <div class="form-row">
          <div class="form-group">
            <label>
              Nome do Cartão
              <button class="help-trigger" type="button">
                <i class="fas fa-question-circle"></i>
              </button>
            </label>
            <div class="help-popup">
              <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent);">Identifique seu cartão</div>
              <div>Nome do cartão (Visa, Mastercard, Nubank, Santander, etc.). Ajuda a separar os gastos por cartão.</div>
              <div class="help-icon" onclick="this.parentElement.style.display='none'" title="Fechar">
                <i class="fas fa-times"></i>
              </div>
            </div>
            <input id="ccNome" placeholder="Visa, Mastercard..." required>
          </div>
          <div class="form-group">
            <label>
              Vencimento
              <button class="help-trigger" type="button">
                <i class="fas fa-question-circle"></i>
              </button>
            </label>
            <div class="help-popup">
              <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent);">Data crítica</div>
              <div>Data de fechamento da fatura do cartão. Importante para planejar o pagamento mensal.</div>
              <div class="help-icon" onclick="this.parentElement.style.display='none'" title="Fechar">
                <i class="fas fa-times"></i>
              </div>
            </div>
            <input id="ccVenc" type="date" required>
          </div>
          <div class="form-group">
            <label>
              Valor Gasto
              <button class="help-trigger" type="button">
                <i class="fas fa-question-circle"></i>
              </button>
            </label>
            <div class="help-popup">
              <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent);">Controle total</div>
              <div>Total gasto no cartão neste período. Some todos os gastos para ter visão completa da fatura.</div>
              <div class="help-icon" onclick="this.parentElement.style.display='none'" title="Fechar">
                <i class="fas fa-times"></i>
              </div>
            </div>
            <input id="ccValor" type="number" step="0.01" placeholder="0,00" required>
          </div>
          <div class="form-group" style="align-self: end;">
            <button id="btnAddCC" class="btn primary">
              <i class="fas fa-plus"></i> Registrar Gasto
            </button>
          </div>
        </div>
      </div>
      
      <div class="table-container space-top">
        <table id="tblCC">
          <thead>
            <tr>
              <th><i class="fas fa-credit-card"></i> Cartão</th>
              <th><i class="fas fa-calendar"></i> Vencimento</th>
              <th class="text-right"><i class="fas fa-money-bill-wave"></i> Valor</th>
              <th class="text-right"><i class="fas fa-cog"></i></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
      <div id="emptyCC" class="empty-state">
        <i class="fas fa-credit-card"></i>
        <h3>Nenhum cartão registrado</h3>
        <p>Adicione seus cartões para controle completo dos gastos!</p>
        <button class="empty-action" onclick="document.getElementById('ccNome').focus()">
          <i class="fas fa-plus"></i> Primeiro Cartão
        </button>
      </div>
    </section>

    <!-- METAS -->
    <section id="tab-metas" class="tab card animate-fade-in" style="display: none;">
      <h2><i class="fas fa-bullseye"></i> Metas Financeiras</h2>
      <div class="form-grid">
        <div class="form-row">
          <div class="form-group">
            <label>
              Objetivo
              <button class="help-trigger" type="button">
                <i class="fas fa-question-circle"></i>
              </button>
            </label>
            <div class="help-popup">
              <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent);">Mantenha o foco</div>
              <div>Para que você está poupando? (Viagem aos EUA, carro novo, fundo de emergência, curso). Seja específico!</div>
              <div class="help-icon" onclick="this.parentElement.style.display='none'" title="Fechar">
                <i class="fas fa-times"></i>
              </div>
            </div>
            <input id="metaDesc" placeholder="Ex: Novo notebook, Viagem..." required>
          </div>
          <div class="form-group">
            <label>
              Valor Alvo
              <button class="help-trigger" type="button">
                <i class="fas fa-question-circle"></i>
              </button>
            </label>
            <div class="help-popup">
              <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent);">Seja realista</div>
              <div>Quanto você quer economizar para este objetivo. O sistema mostrará seu progresso em tempo real.</div>
              <div class="help-icon" onclick="this.parentElement.style.display='none'" title="Fechar">
                <i class="fas fa-times"></i>
              </div>
            </div>
            <input id="metaValor" type="number" step="0.01" placeholder="0,00" required>
          </div>
          <div class="form-group" style="align-self: end;">
            <button id="btnAddMeta" class="btn success">
              <i class="fas fa-plus"></i> Criar Meta
            </button>
          </div>
        </div>
      </div>
      
      <div class="goals-grid" id="goalsGrid"></div>
      
      <div id="emptyMetas" class="empty-state">
        <i class="fas fa-bullseye"></i>
        <h3>Nenhuma meta criada</h3>
        <p>Crie sua primeira meta financeira e acompanhe seu progresso em tempo real!</p>
        <button class="empty-action" onclick="document.getElementById('metaDesc').focus()">
          <i class="fas fa-plus"></i> Primeira Meta
        </button>
      </div>
    </section>

    <!-- POST-ITS -->
    <section id="tab-listas" class="tab card animate-fade-in" style="display: none;">
      <div class="notes-header">
        <h2><i class="fas fa-sticky-note"></i> Post-its & Lembretes</h2>
        <button id="btnNovaNota" class="btn primary">
          <i class="fas fa-plus"></i> Nova Nota
        </button>
      </div>
      <div class="notes-grid" id="notesGrid"></div>
      
      <div id="emptyNotes" class="empty-state">
        <i class="fas fa-sticky-note"></i>
        <h3>Nenhum post-it criado</h3>
        <p>Crie sua primeira nota para organizar seus pensamentos financeiros!</p>
        <button class="empty-action" onclick="document.getElementById('btnNovaNota').click()">
          <i class="fas fa-plus"></i> Primeira Nota
        </button>
      </div>
    </section>

    <!-- CONFIGURAÇÕES -->
    <section id="tab-relatorios" class="tab card animate-fade-in" style="display: none;">
      <h2><i class="fas fa-cog"></i> Configurações & Relatórios</h2>
      
      <div class="card space-top">
        <h3><i class="fas fa-chart-pie"></i> Resumo por Categoria</h3>
        <div id="relatorioCategorias" class="space-top"></div>
      </div>
      
      <div class="card space-top">
        <h3><i class="fas fa-history"></i> Histórico Mensal</h3>
        <div id="relatorioHistorico" class="space-top"></div>
      </div>
      
      <div class="card space-top">
        <h3><i class="fas fa-database"></i> Backup & Exportar</h3>
        <div class="form-row">
          <div class="form-group">
            <button id="btnExport" class="btn primary">
              <i class="fas fa-download"></i> Exportar Dados
            </button>
          </div>
          <div class="form-group">
            <button id="btnImport" class="btn ghost">
              <i class="fas fa-upload"></i> Importar Dados
            </button>
          </div>
        </div>
        <input type="file" id="fileImport" accept=".json" style="display: none;">
      </div>
      
      <div class="card space-top">
        <h3><i class="fas fa-trash-alt"></i> Limpar Dados</h3>
        <button id="btnReset" class="btn danger space-top">
          <i class="fas fa-exclamation-triangle"></i> Resetar Tudo
        </button>
        <p class="text-small text-muted space-top">
          Isso apagará todos os dados salvos no seu dispositivo
        </p>
      </div>
    </section>
  </main>

  <script>
    // ======= Enhanced Helpers =======
    const fmtBRL = (n, decimals = 2) => (n || 0).toLocaleString('pt-BR', { 
      style: 'currency', 
      currency: 'BRL',
      minimumFractionDigits: decimals,
      maximumFractionDigits: decimals
    });

    const parseN = (v) => {
      const num = Number(String(v).replace(',', '.').replace('R$', '').trim());
      return isNaN(num) ? 0 : num;
    };

    const today = () => new Date();
    const getPeriod = (d) => {
      const date = new Date(d || today());
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    };

    const formatDate = (date) => new Date(date).toLocaleDateString('pt-BR');

    const showNotification = (message, type = 'success') => {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: ${getComputedStyle(document.documentElement).getPropertyValue('--radius')};
        color: white;
        font-weight: 600;
        z-index: 1000;
        transform: translateX(400px);
        transition: transform 0.3s ease;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      `;
      
      const colors = {
        success: '#10b981',
        error: '#ef4444',
        warning: '#f59e0b',
        info: '#3b82f6'
     
      };
      
      notification.style.background = colors[type];
      notification.textContent = message;
      document.body.appendChild(notification);
      
      requestAnimationFrame(() => {
        notification.style.transform = 'translateX(0)';
      });
      
      setTimeout(() => {
        notification.style.transform = 'translateX(400px)';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    };

    // ======= Enhanced State Management =======
    let state = JSON.parse(localStorage.getItem('fin-state-pro') || '{}');
    let currentPeriod = getPeriod();
    let onboardingStep = parseInt(localStorage.getItem('onboarding-step') || '0');
    let onboardingCompleted = localStorage.getItem('onboarding-completed') === 'true';
    
    // Initialize state with better defaults
    if (!state.periodos) {
      state = {
        periodos: {},
        tipos: ['Moradia', 'Alimentação', 'Transporte', 'Saúde', 'Educação', 'Lazer', 'Outros'],
        metas: [],
        notas: [],
        stats: {
          firstUse: new Date().toISOString(),
          lastBackup: null
        }
      };
    }

    function ensurePeriod(p) {
      if (!state.periodos[p]) {
        state.periodos[p] = { 
          rendas: [], 
          despesas: [], 
          cartoes: [],
          created: new Date().toISOString()
        };
      }
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    let debounceSave = debounce(saveState, 500);

    function saveState(autoSave = true) {
      try {
        localStorage.setItem('fin-state-pro', JSON.stringify(state));
        if (autoSave && !notaAtiva) return;
        
        if (state.stats.lastBackup !== getPeriod()) {
          state.stats.lastBackup = getPeriod();
          if (!notaAtiva) {
            showNotification('Dados salvos automaticamente', 'info');
          }
        }
        renderAll();
      } catch (e) {
        showNotification('Erro ao salvar dados', 'error');
        console.error('Save error:', e);
      }
    }

    // ======= Enhanced Periods - Mês atual primeiro =======
    function renderPeriods() {
      const currentPeriodText = document.getElementById('currentPeriodText');
      const periodList = document.getElementById('periodList');
      
      const periods = Object.keys(state.periodos);
      if (periods.length === 0) {
        currentPeriodText.textContent = 'Este mês';
        periodList.innerHTML = '<div class="period-option disabled">Nenhum período criado</div>';
        return;
      }
      
      // Ordena com mês atual primeiro, depois decrescente
      const sortedPeriods = [currentPeriod, ...periods.filter(p => p !== currentPeriod).sort((a, b) => b.localeCompare(a))];
      
      // Atualiza texto do período atual
      const currentPeriodDate = new Date(currentPeriod + '-01');
      const currentMonthName = currentPeriodDate.toLocaleDateString('pt-BR', { 
        month: 'long', 
        year: 'numeric' 
      });
      currentPeriodText.textContent = currentMonthName;
      
      // Preenche lista de períodos
      periodList.innerHTML = '';
      
      sortedPeriods.forEach(period => {
        const periodDate = new Date(period + '-01');
        const monthName = periodDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
        const isCurrent = period === currentPeriod;
        
        const option = document.createElement('div');
        option.className = `period-option ${isCurrent ? 'current' : ''}`;
        option.innerHTML = `
          <i class="fas ${isCurrent ? 'fa-check-circle' : 'fa-calendar-alt'}"></i>
          ${monthName}
        `;
        option.onclick = () => {
          currentPeriod = period;
          renderPeriods();
          renderAll();
          closePeriodList();
          showNotification(`Período alterado para ${monthName}`, 'info');
        };
        periodList.appendChild(option);
      });
    }

    function togglePeriodList() {
      const list = document.getElementById('periodList');
      list.classList.toggle('show');
    }

    function closePeriodList() {
      document.getElementById('periodList').classList.remove('show');
    }

    // Fecha lista ao clicar fora
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.period-dropdown')) {
        closePeriodList();
      }
    });

    // ======= Onboarding System =======
    function initOnboarding() {
      const welcomeScreen = document.getElementById('welcomeScreen');
      
      if (!onboardingCompleted && onboardingStep === 0) {
        welcomeScreen.style.display = 'block';
        // Não mostra nenhuma aba durante onboarding
        document.querySelectorAll('.tab').forEach(tab => tab.style.display = 'none');
        showWelcomeScreen();
      } else {
        welcomeScreen.style.display = 'none';
        // Mostra dashboard por padrão
        navigateToTab('dashboard');
      }
    }

    function showWelcomeScreen() {
      document.getElementById('startOnboarding').onclick = () => {
        nextOnboardingStep(1);
      };
      
      document.getElementById('skipOnboarding').onclick = () => {
        completeOnboarding();
      };
    }

    function nextOnboardingStep(step) {
      onboardingStep = step;
      localStorage.setItem('onboarding-step', step);
      
      const steps = ['step1', 'step2', 'step3'];
      steps.forEach((s, i) => {
        const stepEl = document.getElementById(s);
        if (i < step - 1) {
          stepEl.classList.add('completed');
        }
      });
      
      switch(step) {
        case 1:
          navigateToTab('renda');
          showGuidedInput('renda');
          break;
        case 2:
          navigateToTab('despesas');
          showGuidedInput('despesas');
          break;
        case 3:
          navigateToTab('metas');
          showGuidedInput('metas');
          break;
      }
    }

    function showGuidedInput(type) {
      let message, focusElement;
      
      switch(type) {
        case 'renda':
          message = 'Vamos começar! Adicione sua principal fonte de renda mensal.';
          focusElement = 'rendaNome';
          break;
        case 'despesas':
          message = 'Ótimo! Agora registre sua maior despesa fixa mensal.';
          focusElement = 'despNome';
          break;
        case 'metas':
          message = 'Por último, defina um objetivo financeiro para se motivar!';
          focusElement = 'metaDesc';
          break;
      }
      
      showNotification(message, 'info');
      setTimeout(() => document.getElementById(focusElement)?.focus(), 500);
    }

    function completeOnboarding() {
      onboardingCompleted = true;
      onboardingStep = 0;
      localStorage.setItem('onboarding-completed', 'true');
      localStorage.setItem('onboarding-step', '0');
      
      document.getElementById('welcomeScreen').style.display = 'none';
      navigateToTab('dashboard');
      
      showNotification('Bem-vindo ao seu dashboard! 🎉 Seus dados estão prontos!', 'success');
    }

    function trackOnboardingProgress(action) {
      if (!onboardingCompleted) {
        switch(action) {
          case 'add-renda':
            if (onboardingStep === 1) nextOnboardingStep(2);
            break;
          case 'add-despesa':
            if (onboardingStep === 2) nextOnboardingStep(3);
            break;
          case 'add-meta':
            if (onboardingStep === 3) completeOnboarding();
            break;
        }
      }
    }

    // ======= Enhanced Renda =======
    document.getElementById('btnAddRenda').onclick = () => {
      const nome = document.getElementById('rendaNome').value.trim();    
      const valor = parseN(document.getElementById('rendaValor').value);
      const data = document.getElementById('rendaData').value;
      const meses = parseInt(document.getElementById('rendaRecorrente').value);
      
      if (!nome || !valor || !data) {
        showNotification('Preencha todos os campos obrigatórios', 'error');
        return;
      }

      if (valor <= 0) {
        showNotification('O valor deve ser maior que zero', 'error');
        return;
      }

      const d = new Date(data);
      const p = getPeriod(d);
      ensurePeriod(p);
      
      const renda = {
        id: Date.now() + Math.random(),
        nome,
        valor,
        data: d.toISOString(),
        recorrente: meses > 0,
        categoria: 'Renda',
        tags: ['confirmado']
      };
      
      state.periodos[p].rendas.push(renda);
      currentPeriod = p;

      if (meses > 0) {
        for (let i = 1; i < meses; i++) {
          const futureDate = new Date(d);
          futureDate.setMonth(futureDate.getMonth() + i);
          const futurePeriod = getPeriod(futureDate);
          ensurePeriod(futurePeriod);
          
          state.periodos[futurePeriod].rendas.push({
            ...renda,
            id: Date.now() + Math.random() + i,
            data: futureDate.toISOString()
          });
        }
        showNotification(`Renda recorrente criada por ${meses} meses!`, 'success');
      }

      // Clear form
      document.getElementById('rendaNome').value = '';
      document.getElementById('rendaValor').value = '';
      document.getElementById('rendaData').value = '';
      document.getElementById('rendaRecorrente').value = '0';
      
      showNotification(`Renda "${nome}" adicionada com sucesso! 💰`, 'success');
      trackOnboardingProgress('add-renda');
      saveState();
    };

    function renderRenda() {
      ensurePeriod(currentPeriod);
      const tbody = document.querySelector('#tblRenda tbody');
      const emptyState = document.getElementById('emptyRenda');
      
      tbody.innerHTML = '';
      const rendas = state.periodos[currentPeriod].rendas || [];
      
      if (rendas.length === 0) {
        emptyState.style.display = 'block';
        return;
      }
      
      emptyState.style.display = 'none';
      
      rendas
        .sort((a, b) => new Date(a.data) - new Date(b.data))
        .forEach(renda => {
          const tr = document.createElement('tr');
          tr.className = 'animate-fade-in';
          tr.innerHTML = `
            <td>
              <div class="tag income">
                <i class="fas fa-arrow-up"></i> ${renda.nome}
              </div>
            </td>
            <td>${formatDate(renda.data)}</td>
            <td class="text-right">${fmtBRL(renda.valor)}</td>
            <td class="text-right">
              <button class="btn ghost btn-small danger" onclick="deleteItem('renda', ${renda.id}, this)" title="Excluir">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
    }

    // ======= Enhanced Tipos =======
    function renderTipos() {
      const sel = document.getElementById('despTipo');
      sel.innerHTML = '<option value="">Selecione...</option>';
      
      state.tipos.forEach(tipo => {
        const option = document.createElement('option');
        option.value = tipo;
        option.textContent = tipo;
        sel.appendChild(option);
      });
    }

    document.getElementById('btnAddTipo').onclick = () => {
      const novoTipo = document.getElementById('novoTipo').value.trim();
      if (novoTipo && !state.tipos.includes(novoTipo)) {
        state.tipos.push(novoTipo);
        document.getElementById('novoTipo').value = '';
        saveState();
        showNotification(`Categoria "${novoTipo}" adicionada`, 'success');
        renderTipos();
      } else if (novoTipo) {
        showNotification('Categoria já existe', 'warning');
      }
    };

    // ======= Enhanced Despesas =======
    document.getElementById('btnAddDesp').onclick = () => {
      const nome = document.getElementById('despNome').value.trim();
      const valor = parseN(document.getElementById('despValor').value);
      const data = document.getElementById('despData').value;
      const tipo = document.getElementById('despTipo').value;
      const meses = parseInt(document.getElementById('despRecorrente').value);
      
      if (!nome || !valor || !data || !tipo) {
        showNotification('Preencha todos os campos obrigatórios', 'error');
        return;
      }

      if (valor <= 0) {
        showNotification('O valor deve ser maior que zero', 'error');
        return;
      }

      const d = new Date(data);
      const p = getPeriod(d);
      ensurePeriod(p);
      
      const despesa = {
        id: Date.now() + Math.random(),
        nome,
        valor,
        data: d.toISOString(),
        tipo,
        recorrente: meses > 0,
        tags: ['pendente'],
        created: new Date().toISOString()
      };
      
      state.periodos[p].despesas.push(despesa);
      currentPeriod = p;

      if (meses > 0) {
        for (let i = 1; i < meses; i++) {
          const futureDate = new Date(d);
          futureDate.setMonth(futureDate.getMonth() + i);
          const futurePeriod = getPeriod(futureDate);
          ensurePeriod(futurePeriod);
          
          state.periodos[futurePeriod].despesas.push({
            ...despesa,
            id: Date.now() + Math.random() + i,
            data: futureDate.toISOString()
          });
        }
        showNotification(`Despesa recorrente criada por ${meses} meses!`, 'warning');
      }

      // Clear form
      document.getElementById('despNome').value = '';
      document.getElementById('despValor').value = '';
      document.getElementById('despData').value = '';
      document.getElementById('despRecorrente').value = '0';
      document.getElementById('despTipo').value = '';
      
      showNotification(`Despesa "${nome}" registrada`, 'warning');
      trackOnboardingProgress('add-despesa');
      saveState();
    };

    function renderDesp() {
      ensurePeriod(currentPeriod);
      const tbody = document.querySelector('#tblDesp tbody');
      const emptyState = document.getElementById('emptyDesp');
      
      tbody.innerHTML = '';
      const despesas = state.periodos[currentPeriod].despesas || [];
      
      if (despesas.length === 0) {
        emptyState.style.display = 'block';
        return;
      }
      
      emptyState.style.display = 'none';
      
      despesas
        .sort((a, b) => new Date(a.data) - new Date(b.data))
        .forEach(d => {
          const isOverdue = new Date(d.data) < today();
          const tr = document.createElement('tr');
          tr.className = isOverdue ? 'bg-red-50' : 'animate-fade-in';
          tr.innerHTML = `
            <td>
              <div class="tag expense">
                <i class="fas fa-arrow-down"></i> ${d.nome}
              </div>
            </td>
            <td>
              <span style="color: ${isOverdue ? 'var(--danger)' : 'var(--text)'}">
                ${formatDate(d.data)}
                ${isOverdue ? '<i class="fas fa-exclamation-triangle" style="margin-left: 0.5rem; color: var(--danger);"></i>' : ''}
              </span>
            </td>
            <td><span class="tag" style="background: rgba(59, 130, 246, 0.1); color: var(--accent-2); border-color: var(--accent-2);">${d.tipo}</span></td>
            <td class="text-right text-red-600">${fmtBRL(d.valor)}</td>
            <td class="text-right">
              <button class="btn ghost btn-small danger" onclick="deleteItem('despesa', ${d.id}, this)" title="Excluir">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
    }

    // ======= Enhanced Cartões =======
    document.getElementById('btnAddCC').onclick = () => {
      const nome = document.getElementById('ccNome').value.trim();
      const valor = parseN(document.getElementById('ccValor').value);
      const venc = document.getElementById('ccVenc').value;
      
      if (!nome || !valor || !venc) {
        showNotification('Preencha todos os campos obrigatórios', 'error');
        return;
      }

      if (valor <= 0) {
        showNotification('O valor deve ser maior que zero', 'error');
        return;
      }

      const d = new Date(venc);
      const p = getPeriod(d);
      ensurePeriod(p);
      
      const cartao = {
        id: Date.now() + Math.random(),
        nome,
        valor,
        venc: d.toISOString(),
        tags: ['pendente'],
        created: new Date().toISOString()
      };
      
      state.periodos[p].cartoes.push(cartao);
      currentPeriod = p;

      // Clear form
      document.getElementById('ccNome').value = '';
      document.getElementById('ccValor').value = '';
      document.getElementById('ccVenc').value = '';
      
      showNotification(`Gasto no cartão "${nome}" registrado`, 'warning');
      saveState();
    };

    function renderCC() {
      ensurePeriod(currentPeriod);
      const tbody = document.querySelector('#tblCC tbody');
      const emptyState = document.getElementById('emptyCC');
      
      tbody.innerHTML = '';
      const cartoes = state.periodos[currentPeriod].cartoes || [];
      
      if (cartoes.length === 0) {
        emptyState.style.display = 'block';
        return;
      }
      
      emptyState.style.display = 'none';
      
      cartoes
        .sort((a, b) => new Date(a.venc) - new Date(b.venc))
        .forEach(c => {
          const isOverdue = new Date(c.venc) < today();
          const tr = document.createElement('tr');
          tr.className = isOverdue ? 'bg-red-50' : 'animate-fade-in';
          tr.innerHTML = `
            <td>
              <div class="tag" style="background: rgba(59, 130, 246, 0.1); color: var(--accent-2); border-color: var(--accent-2);">
                <i class="fas fa-credit-card"></i> ${c.nome}
              </div>
            </td>
            <td>
              <span style="color: ${isOverdue ? 'var(--danger)' : 'var(--text)'}">
                ${formatDate(c.venc)}
                ${isOverdue ? '<i class="fas fa-exclamation-triangle" style="margin-left: 0.5rem; color: var(--danger);"></i>' : ''}
              </span>
            </td>
            <td class="text-right text-red-600">${fmtBRL(c.valor)}</td>
            <td class="text-right">
              <button class="btn ghost btn-small danger" onclick="deleteItem('cartao', ${c.id}, this)" title="Excluir">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
    }

    // ======= Enhanced Dashboard =======
    function renderDashboard() {
      ensurePeriod(currentPeriod);
      const rendas = state.periodos[currentPeriod].rendas || [];
      const despesas = state.periodos[currentPeriod].despesas || [];
      const cartoes = state.periodos[currentPeriod].cartoes || [];
      
      const totalRendas = rendas.reduce((sum, r) => sum + r.valor, 0);
      const totalDespesas = despesas.reduce((sum, d) => sum + d.valor, 0);
      const totalCartoes = cartoes.reduce((sum, c) => sum + c.valor, 0);
      const saldo = totalRendas;
      const sobra = saldo - totalDespesas - totalCartoes;
      
      // Update KPIs
      document.getElementById('kpiSaldo').textContent = fmtBRL(saldo);
      document.getElementById('kpisomadiv').textContent = fmtBRL(totalDespesas + totalCartoes);
      document.getElementById('kpiSobra').textContent = fmtBRL(sobra);
      
      // Trend indicator
      const trendText = sobra > 500 ? 'Excelente!' : sobra > 0 ? 'Bom!' : 'Ajustar';
      const trendIcon = sobra > 500 ? 'fas fa-trophy' : sobra > 0 ? 'fas fa-smile' : 'fas fa-exclamation-triangle';
      document.getElementById('kpiTrendText').textContent = trendText;
      document.getElementById('kpiTrend').innerHTML = `<i class="${trendIcon}" style="color: ${sobra > 0 ? 'var(--success)' : 'var(--warn)'}"></i> <span>${trendText}</span>`;
      
      // Next due date
      const eventos = [
        ...despesas.map(d => ({ data: d.data, nome: d.nome, tipo: 'despesa' })),
        ...cartoes.map(c => ({ data: c.venc, nome: c.nome, tipo: 'cartao' }))
      ];
      
      const futuros = eventos.filter(e => new Date(e.data) >= today());
      futuros.sort((a, b) => new Date(a.data) - new Date(b.data));
      
      const proximo = futuros.length > 0 
        ? `${formatDate(futuros[0].data)} - ${futuros[0].nome}`
        : 'Nenhum vencimento';
      
      document.getElementById('kpiVencimento').textContent = proximo;
      
      // Economy comparison
      const economia = sobra > 0 ? sobra * 0.1 : 0;
      document.getElementById('kpiEconomia').innerHTML = `
        ${fmtBRL(economia)}
        <span class="text-small" style="display: block; opacity: 0.8;">
          ${sobra >= 0 ? '📈 Positivo' : '📉 Ajustar gastos'}
        </span>
      `;
      
      renderRecentes();
    }

    function renderRecentes() {
      ensurePeriod(currentPeriod);
      const rendas = state.periodos[currentPeriod].rendas || [];
      const despesas = state.periodos[currentPeriod].despesas || [];
      const cartoes = state.periodos[currentPeriod].cartoes || [];
      
      const todas = [
        ...rendas.map(r => ({ ...r, tipo: 'renda' })),
        ...despesas.map(d => ({ ...d, tipo: 'despesa' })),
        ...cartoes.map(c => ({ ...c, tipo: 'cartao', data: c.venc }))
      ];
      
      const recentes = todas
        .sort((a, b) => new Date(b.data || b.venc) - new Date(a.data || a.venc))
        .slice(0, 5);
      
      const tbody = document.querySelector('#tblRecentes tbody');
      const emptyState = document.getElementById('emptyRecentes');
      
      tbody.innerHTML = '';
      
      if (recentes.length === 0) {
        emptyState.style.display = 'block';
        return;
      }
      
      emptyState.style.display = 'none';
      
      recentes.forEach(item => {
        const tr = document.createElement('tr');
        tr.className = 'animate-fade-in';
        const isRenda = item.tipo === 'renda';
        const valor = fmtBRL(item.valor);
        const data = formatDate(item.data || item.venc);
        
        tr.innerHTML = `
          <td>
            <div class="tag ${isRenda ? 'income' : 'expense'}">
              <i class="fas fa-${isRenda ? 'arrow-up' : 'arrow-down'}"></i> 
              ${item.nome}
            </div>
          </td>
          <td>${data}</td>
          <td class="text-right ${isRenda ? 'text-green-600' : 'text-red-600'}">${valor}</td>
          <td class="text-right">
            <button class="btn ghost btn-small danger" onclick="deleteItem('${item.tipo}', ${item.id}, this)" title="Excluir">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ======= Enhanced Metas =======
    function addMeta() {
      const desc = document.getElementById('metaDesc').value.trim();
      const alvo = parseN(document.getElementById('metaValor').value);
      
      if (!desc || !alvo) {
        showNotification('Informe descrição e valor da meta', 'error');
        return;
      }
      
      if (alvo <= 0) {
        showNotification('O valor da meta deve ser maior que zero', 'error');
        return;
      }

      const meta = {
        id: Date.now() + Math.random(),
        desc,
        alvo,
        acumulado: 0,
        created: new Date().toISOString(),
        tags: []
      };
      
      state.metas.push(meta);
      document.getElementById('metaDesc').value = '';
      document.getElementById('metaValor').value = '';
      
      showNotification(`Meta "${desc}" criada! 🎯`, 'success');
      trackOnboardingProgress('add-meta');
      saveState();
    }

    document.getElementById('btnAddMeta').onclick = addMeta;

    function renderMetas() {
      const grid = document.getElementById('goalsGrid');
      const emptyState = document.getElementById('emptyMetas');
      
      grid.innerHTML = '';
      
      if (state.metas.length === 0) {
        emptyState.style.display = 'block';
        return;
      }
      
      emptyState.style.display = 'none';
      
      state.metas.forEach(meta => {
        const progresso = meta.alvo > 0 ? (meta.acumulado / meta.alvo) * 100 : 0;
        const progressoFormatado = Math.min(100, Math.round(progresso));
        
        let corClasse = 'progress-red';
        if (progresso > 75) corClasse = 'progress-gold';
        else if (progresso > 50) corClasse = 'progress-green';
        else if (progresso > 25) corClasse = 'progress-orange';
        
        const card = document.createElement('div');
        card.className = 'goal-card animate-fade-in';
        card.innerHTML = `
          <div class="goal-header">
            <h3>${meta.desc}</h3>
            <button class="goal-close" onclick="deleteMeta(${meta.id})" title="Excluir meta">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <div class="goal-stats">
            <div><strong>Alvo:</strong> ${fmtBRL(meta.alvo)}</div>
            <div><strong>Atual:</strong> ${fmtBRL(meta.acumulado)}</div>
          </div>
          
          <div class="progress-bar">
            <div class="progress-fill ${corClasse}" style="width: ${progressoFormatado}%"></div>
          </div>
          
          <div class="goal-stats">
            <div>${progressoFormatado}%</div>
            <div><strong>Falta:</strong> ${fmtBRL(Math.max(0, meta.alvo - meta.acumulado))}</div>
          </div>
          
          <div class="goal-actions">
            <input type="number" class="goal-input" placeholder="Valor" step="0.01">
            <button class="btn success btn-small" onclick="updateMeta(${meta.id}, true, this)">
              <i class="fas fa-plus"></i> Adicionar
            </button>
            <button class="btn danger btn-small" onclick="updateMeta(${meta.id}, false, this)">
              <i class="fas fa-minus"></i> Retirar
            </button>
          </div>
        `;
        
        grid.appendChild(card);
      });
    }

    function updateMeta(id, isAdd, button) {
      const meta = state.metas.find(m => m.id === id);
      if (!meta) return;
      
      const input = button.parentElement.querySelector('input');
      const valor = parseN(input.value);
      
      if (!valor || valor <= 0) {
        showNotification('Informe um valor válido', 'error');
        return;
      }
      
      if (isAdd) {
        meta.acumulado = Math.min(meta.alvo, meta.acumulado + valor);
        showNotification(`+${fmtBRL(valor)} adicionado à meta "${meta.desc}"`, 'success');
      } else {
        meta.acumulado = Math.max(0, meta.acumulado - valor);
        showNotification(`-${fmtBRL(valor)} removido da meta "${meta.desc}"`, 'warning');
      }
      
      input.value = '';
      saveState();
    }

    function deleteMeta(id) {
      const meta = state.metas.find(m => m.id === id);
      if (confirm(`Deseja realmente excluir a meta "${meta.desc}"?`)) {
        state.metas = state.metas.filter(m => m.id !== id);
        saveState();
        showNotification('Meta excluída', 'warning');
      }
    }

    // ======= Enhanced Notas =======
    let notasRenderizadas = new Map();
    let notaAtiva = null;

    function novaNota() {
      const nota = {
        id: Date.now() + Math.random(),
        texto: '',
        done: false,
        created: new Date().toISOString()
      };
      state.notas.push(nota);
      
      renderNovaNota(nota);
      debounceSave();
      showNotification('Nova nota criada! 📝', 'success');
      
      setTimeout(() => {
        const novaTextarea = document.querySelector(`[data-id="${nota.id}"]`);
        if (novaTextarea) {
          novaTextarea.focus();
        }
      }, 100);
    }

    document.getElementById('btnNovaNota').onclick = novaNota;

    function renderNovaNota(nota) {
      const grid = document.getElementById('notesGrid');
      const existingCard = document.querySelector(`[data-note-id="${nota.id}"]`);
      
      if (existingCard) {
        const textarea = existingCard.querySelector('.note-content');
        textarea.value = nota.texto;
        return;
      }
      
      const noteCard = document.createElement('div');
      noteCard.className = `note-card ${nota.done ? 'done' : ''}`;
      noteCard.setAttribute('data-note-id', nota.id);
      noteCard.innerHTML = `
        <button class="note-delete" onclick="deleteNote(${nota.id})" title="Excluir nota">
          <i class="fas fa-times"></i>
        </button>
        <textarea class="note-content" 
                  placeholder="Escreva sua anotação aqui... 📝" 
                  data-id="${nota.id}">${nota.texto}</textarea>
        <div class="note-footer">
          <input type="checkbox" class="note-checkbox" ${nota.done ? 'checked' : ''} onchange="toggleNote(${nota.id}, this)">
        </div>
      `;
      
      const textarea = noteCard.querySelector('.note-content');
      const checkbox = noteCard.querySelector('.note-checkbox');
      
      function salvarNotaAtual() {
        if (notaAtiva && notaAtiva !== nota.id) {
          const notaAtual = state.notas.find(n => n.id === notaAtiva);
          if (notaAtual) {
            const textareaAtual = document.querySelector(`[data-id="${notaAtiva}"]`);
            if (textareaAtual) {
              notaAtual.texto = textareaAtual.value;
              notaAtual.updated = new Date().toISOString();
            }
          }
        }
      }
      
      textarea.addEventListener('input', (e) => {
        salvarNotaAtual();
        notaAtiva = nota.id;
        
        const targetNota = state.notas.find(n => n.id == nota.id);
        if (targetNota) {
          targetNota.texto = e.target.value;
          targetNota.updated = new Date().toISOString();
        }
        
        debounceSave();
      });
      
      textarea.addEventListener('focus', () => {
        salvarNotaAtual();
        notaAtiva = nota.id;
        notasRenderizadas.set(nota.id, noteCard);
      });
      
      textarea.addEventListener('blur', () => {
        if (notaAtiva === nota.id) {
          const targetNota = state.notas.find(n => n.id == nota.id);
          if (targetNota) {
            targetNota.texto = textarea.value;
            targetNota.updated = new Date().toISOString();
            saveState();
            notaAtiva = null;
          }
        }
      });
      
      checkbox.addEventListener('change', (e) => {
        const targetNota = state.notas.find(n => n.id == nota.id);
        if (targetNota) {
          targetNota.done = e.target.checked;
          targetNota.updated = new Date().toISOString();
          noteCard.classList.toggle('done', targetNota.done);
          debounceSave();
          showNotification(e.target.checked ? 'Nota marcada como concluída! ✅' : 'Nota reaberta', 'info');
        }
      });
      
      grid.appendChild(noteCard);
      notasRenderizadas.set(nota.id, noteCard);
      
      if (state.notas.length === 1) {
        setTimeout(() => textarea.focus(), 100);
      }
    }

    function renderNotas() {
      const grid = document.getElementById('notesGrid');
      const emptyState = document.getElementById('emptyNotes');
      
      if (grid.children.length === 0 || state.notas.length === 0) {
        grid.innerHTML = '';
        notasRenderizadas.clear();
      }
      
      if (state.notas.length === 0) {
        emptyState.style.display = 'block';
        return;
      }
      
      emptyState.style.display = 'none';
      
      state.notas.forEach(nota => {
        if (!notasRenderizadas.has(nota.id)) {
          renderNovaNota(nota);
        } else {
          const existingCard = notasRenderizadas.get(nota.id);
          const textarea = existingCard.querySelector('.note-content');
          const checkbox = existingCard.querySelector('.note-checkbox');
          
          if (textarea.value !== nota.texto) {
            textarea.value = nota.texto;
          }
          
          if (checkbox.checked !== nota.done) {
            checkbox.checked = nota.done;
            existingCard.classList.toggle('done', nota.done);
          }
        }
      });
      
      Array.from(grid.children).forEach(child => {
        if (!state.notas.some(nota => nota.id == child.getAttribute('data-note-id'))) {
          child.remove();
          notasRenderizadas.delete(parseFloat(child.getAttribute('data-note-id')));
        }
      });
    }

    function toggleNote(id, checkbox) {
      const nota = state.notas.find(n => n.id === id);
      if (nota) {
        nota.done = checkbox.checked;
        nota.updated = new Date().toISOString();
        
        const card = notasRenderizadas.get(id);
        if (card) {
          card.classList.toggle('done', nota.done);
        }
        
        debounceSave();
        showNotification(checkbox.checked ? 'Nota marcada como concluída! ✅' : 'Nota reaberta', 'info');
      }
    }

    function deleteNote(id) {
      const nota = state.notas.find(n => n.id === id);
      const hasContent = nota && nota.texto.trim().length > 0;
      
      if (hasContent && !confirm('Esta nota possui conteúdo. Deseja realmente excluir?')) {
        return;
      }
      
      state.notas = state.notas.filter(n => n.id !== id);
      
      const card = notasRenderizadas.get(id);
      if (card) {
        card.style.transition = 'all 0.3s ease';
        card.style.opacity = '0';
        card.style.transform = 'scale(0.8)';
        setTimeout(() => {
          card.remove();
          notasRenderizadas.delete(id);
        }, 300);
      }
      
      saveState();
      showNotification('Nota excluída', 'warning');
      
      if (notaAtiva === id) {
        notaAtiva = null;
      }
    }

    // ======= Delete Helper =======
    window.deleteItem = function(type, id, button) {
      const confirmMsg = type === 'renda' ? 'excluir esta renda?' : 
                        type === 'despesa' ? 'excluir esta despesa?' : 
                        'excluir este cartão?';
      
      if (confirm(`Deseja realmente ${confirmMsg}`)) {
        ensurePeriod(currentPeriod);
        const items = state.periodos[currentPeriod][type + 's'];
        state.periodos[currentPeriod][type + 's'] = items.filter(item => item.id !== id);
        saveState();
        showNotification('Item excluído', 'warning');
        button.closest('tr').style.opacity = '0';
        setTimeout(() => button.closest('tr').remove(), 300);
      }
    };

    // ======= Enhanced Reports =======
    function renderRelatorios() {
      // Category report
      const relCat = document.getElementById('relatorioCategorias');
      ensurePeriod(currentPeriod);
      const despesas = state.periodos[currentPeriod].despesas || [];
      
      if (despesas.length === 0) {
        relCat.innerHTML = '<p class="text-muted">Nenhuma despesa para análise</p>';
        return;
      }
      
      const porCategoria = {};
      despesas.forEach(d => {
        porCategoria[d.tipo] = (porCategoria[d.tipo] || 0) + d.valor;
      });
      
      let relHTML = '<div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">';
      Object.entries(porCategoria)
        .sort(([,a], [,b]) => b - a)
        .forEach(([cat, val]) => {
          const pct = (val / despesas.reduce((s, d) => s + d.valor, 0)) * 100;
          relHTML += `
            <div class="card">
              <div class="text-right" style="font-size: 1.5rem; font-weight: 700; color: var(--danger);">${fmtBRL(val)}</div>
              <div style="font-size: 0.875rem; color: var(--text-dim);">${cat}</div>
              <div class="text-small text-muted">${Math.round(pct)}% do total</div>
            </div>
          `;
        });
      relHTML += '</div>';
      relCat.innerHTML = relHTML;
      
      // Monthly history
      const relHist = document.getElementById('relatorioHistorico');
      const periods = Object.keys(state.periodos).sort().slice(-6);
      
      let histHTML = '<div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">';
      periods.forEach(p => {
        const periodData = state.periodos[p];
        const renda = (periodData.rendas || []).reduce((s, r) => s + r.valor, 0);
        const despesa = ((periodData.despesas || []).reduce((s, d) => s + d.valor, 0) + 
                        (periodData.cartoes || []).reduce((s, c) => s + c.valor, 0));
        const saldo = renda - despesa;
        
        const trend = saldo >= 0 ? 'success' : 'danger';
        histHTML += `
          <div class="card text-center">
            <div class="text-small text-muted">${p}</div>
            <div class="${trend === 'success' ? 'text-success' : 'text-danger'} font-bold">${fmtBRL(saldo)}</div>
            <div class="text-small text-muted">Saldo</div>
          </div>
        `;
      });
      histHTML += '</div>';
      relHist.innerHTML = histHTML;
    }

    // ======= Export/Import =======
    document.getElementById('btnExport').onclick = () => {
      const dataStr = JSON.stringify(state, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `financeiro-${getPeriod()}.json`;
      link.click();
      URL.revokeObjectURL(url);
      showNotification('Dados exportados com sucesso!', 'success');
    };

    document.getElementById('btnImport').onclick = () => {
      document.getElementById('fileImport').click();
    };

    document.getElementById('fileImport').onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const importedState = JSON.parse(e.target.result);
          if (confirm('Deseja importar estes dados? Isso substituirá os dados atuais.')) {
            state = { ...state, ...importedState };
            saveState();
            showNotification('Dados importados com sucesso!', 'success');
            renderAll();
          }
        } catch (err) {
          showNotification('Erro ao importar arquivo. Verifique o formato.', 'error');
        }
      };
      reader.readAsText(file);
    };

    // ======= Reset =======
    document.getElementById('btnReset').onclick = () => {
      if (confirm('⚠️ ATENÇÃO: Isso apagará TODOS os seus dados! Deseja continuar?')) {
        if (confirm('TEM CERTEZA? Esta ação não pode ser desfeita.')) {
          localStorage.removeItem('fin-state-pro');
          localStorage.removeItem('onboarding-completed');
          localStorage.removeItem('onboarding-step');
          location.reload();
        }
      }
    };

    // ======= Navigation System - Todas as abas controladas =======
    window.navigateToTab = function(tabId) {
      // Esconde todas as abas
      document.querySelectorAll('.tab').forEach(t => {
        t.classList.remove('active');
        t.style.display = 'none';
      });
      
      // Remove active de todos os itens de navegação
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // Mostra aba selecionada
      const targetTab = document.getElementById(`tab-${tabId}`);
      if (targetTab) {
        targetTab.style.display = 'block';
        targetTab.classList.add('active');
      }
      
      // Marca item de navegação ativo
      const activeItem = document.querySelector(`[data-tab="${tabId}"]`);
      if (activeItem) {
        activeItem.classList.add('active');
      }
      
      // Fecha menu lateral
      closeSideNav();
      
      // Renderiza conteúdo específico da aba
      switch(tabId) {
        case 'dashboard':
          renderDashboard();
          break;
        case 'renda':
          renderRenda();
          break;
        case 'despesas':
          renderDesp();
          renderTipos();
          break;
        case 'cartoes':
          renderCC();
          break;
        case 'metas':
          renderMetas();
          break;
        case 'listas':
          renderNotas();
          break;
        case 'relatorios':
          renderRelatorios();
          break;
      }
      
      showNotification(`Carregando ${tabId}`, 'info');
    };

    function initNavigation() {
      // Side nav toggle
      document.getElementById('navToggle').onclick = () => {
        toggleSideNav();
      };
      
      document.getElementById('navOverlay').onclick = () => {
        closeSideNav();
      };
      
      // Nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.onclick = (e) => {
          e.preventDefault();
          const tabId = item.getAttribute('data-tab');
          navigateToTab(tabId);
        };
      });
    }

    function toggleSideNav() {
      const sideNav = document.getElementById('sideNav');
      const overlay = document.getElementById('navOverlay');
      
      sideNav.classList.toggle('open');
      overlay.classList.toggle('show');
      
      document.body.style.overflow = sideNav.classList.contains('open') ? 'hidden' : '';
    }

    function closeSideNav() {
      const sideNav = document.getElementById('sideNav');
      const overlay = document.getElementById('navOverlay');
      
      sideNav.classList.remove('open');
      overlay.classList.remove('show');
      document.body.style.overflow = '';
    }

    // ======= Theme Management =======
    function applyTheme() {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      const isLight = savedTheme === 'light';
      const toggle = document.getElementById('themeToggle');
      const icon = document.getElementById('themeIcon');
      
      document.body.classList.toggle('light', isLight);
      toggle.checked = !isLight;
      icon.className = isLight ? 'fas fa-moon' : 'fas fa-sun';
    }

    document.getElementById('themeToggle').onchange = (e) => {
      const isLight = !e.target.checked;
      localStorage.setItem('theme', isLight ? 'light' : 'dark');
      applyTheme();
      showNotification(isLight ? 'Tema claro ativado' : 'Tema escuro ativado', 'info');
    };

    // ======= Main Render =======
    function renderAll() {
      renderPeriods();
      renderRenda();
      renderDesp();
      renderCC();
      renderDashboard();
      renderTipos();
      renderMetas();
      renderNotas();
    }

    // ======= Initialization =======
    document.addEventListener('DOMContentLoaded', () => {
      // Hide loading
      setTimeout(() => {
        document.getElementById('loading').classList.add('hidden');
      }, 1000);
      
      // Set default dates
      const todayDate = today().toISOString().split('T')[0];
      document.getElementById('rendaData').value = todayDate;
      document.getElementById('despData').value = todayDate;
      document.getElementById('ccVenc').value = todayDate;
      
      // Initialize
      ensurePeriod(currentPeriod);
      initNavigation();
      applyTheme();
      initOnboarding();
      renderAll();
      
      // Auto-save every 30 seconds
      setInterval(() => saveState(true), 30000);
      
      // Welcome message for returning users
      if (onboardingCompleted && !state.stats.firstUse) {
        setTimeout(() => {
          showNotification('Bem-vindo de volta! 📊 Seus dados estão atualizados.', 'success');
        }, 1500);
      }

      // Initialize notes
      if (state.notas && state.notas.length > 0) {
        setTimeout(() => {
          state.notas.forEach(nota => renderNovaNota(nota));
        }, 100);
      }
    });

    // Global functions
    window.deleteItem = window.deleteItem || function() {};
    window.deleteMeta = deleteMeta;
    window.updateMeta = updateMeta;
    window.deleteNote = deleteNote;
    window.toggleNote = toggleNote;
    window.navigateToTab = navigateToTab;
    window.togglePeriodList = togglePeriodList;
    window.closePeriodList = closePeriodList;

    // PWA Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(reg => console.log('SW registered'))
          .catch(err => console.log('SW registration failed'));
      });
    }
  </script>
</body>
</html>
